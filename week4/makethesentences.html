<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />

<!-- //* CHANGE 1/7: Page <title> (week label) *// -->
<title>Booha Make the Sentences – January Week 4</title>

<meta name="theme-color" content="#0b1530" />
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=Noto+Sans+JP:wght@500;700&display=swap" rel="stylesheet" />

<style>
:root{
  --bg:#0b1530; --ink:#fff; --outline:#ffffff26; --radius:26px;
  --slotGlow:0 0 0 4px rgba(255,214,120,.28), 0 0 18px rgba(255,214,120,.55), 0 12px 22px rgba(0,0,0,.35);
}

*{box-sizing:border-box;margin:0;padding:0;}
html,body{height:100%;}
body{
  background:var(--bg);
  color:var(--ink);
  font-family:system-ui,"Noto Sans JP",sans-serif;
  transition:background 1s;
  overflow-x:hidden;
  overflow-y:auto;
  -webkit-overflow-scrolling:touch;
  padding-bottom:env(safe-area-inset-bottom);
}

/* Header */
header{text-align:center;padding:26px 12px 12px}
.h1{font-family:'Cinzel',serif;font-weight:900;font-size:clamp(34px,6.2vw,56px);}
.h2{font-family:'Cinzel',serif;font-weight:900;font-size:clamp(22px,4.5vw,36px);}

/* //* CHANGE 2/7: Week label text shown on page *// */
.h3{font-family:'Cinzel',serif;font-weight:900;font-size:clamp(16px,3.6vw,22px);}
.h4{font-weight:800;font-size:clamp(14px,3.4vw,20px);color:#cfe1ff;}

.wrap{max-width:1100px;margin:0 auto;padding:8px 16px 90px}
.panel{
  padding:20px;
  border:1px solid var(--outline);
  border-radius:var(--radius);
  background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.02));
  box-shadow:0 6px 24px rgba(0,0,0,.4);
  overflow:visible;
}

/* JP card */
.jpCard{
  border-radius:var(--radius);
  border:1px solid var(--outline);
  height:160px;
  display:flex;
  align-items:center;
  justify-content:center;
  margin-bottom:10px;
  background:repeating-linear-gradient(to bottom,#ff6ec7 0 28px,#5ee6ff 28px 56px,#ffd166 56px 84px,
  #8aff80 84px 112px,#c77dff 112px 140px,#fff680 140px 168px);
  background-size:100% 600px;
  animation:stripeSlide 18s linear infinite;
  user-select:none;
  -webkit-tap-highlight-color:transparent;
}
.jpCard.replay{ cursor:pointer; }
.jpCard.locked{
  cursor:default;
  filter:saturate(.92) brightness(.98);
}
@keyframes stripeSlide{from{background-position-y:0}to{background-position-y:-600px}}
.jpText{
  font-weight:900;
  font-size:46px;
  color:#0b1530;
  text-shadow:0 1px 0 rgba(255,255,255,.6);
  text-align:center;
  padding:0 10px;
}
.hira{
  text-align:center;
  color:#d8e7ff;
  font-size:clamp(14px,3.5vw,18px);
  margin-bottom:18px
}

/* Areas */
.wordbank,.sentence{
  display:flex;
  flex-wrap:wrap;
  gap:12px;
  padding:12px;
  margin-bottom:14px;
}
.wordbank{justify-content:center;}
.sentence{
  justify-content:flex-start;
  align-items:center;
  min-height:120px;
  width:100%;
  border:1px dashed rgba(255,255,255,.25);
  border-radius:14px;
  padding:16px 12px;
  position:relative;
}

/* chips */
.word{
  padding:14px 18px;
  font-weight:900;
  font-size:clamp(18px,4.2vw,26px);
  border:none;
  border-radius:20px;
  cursor:pointer;
  user-select:none;
  -webkit-tap-highlight-color:transparent;
  touch-action:manipulation;
  box-shadow:0 0 0 4px var(--color),0 10px 22px rgba(0,0,0,.35);
  background:#fff;
  color:#06101f;
  text-shadow:0 1px 0 rgba(255,255,255,.65);
  transition:transform .12s, box-shadow .12s, filter .12s;
}
.word:active{transform:scale(.96)}
.word.selected{
  transform:translateY(-2px) scale(1.03);
  filter:saturate(1.15) brightness(1.06);
  box-shadow:
    0 0 0 4px rgba(125,211,252,.55),
    0 0 18px rgba(125,211,252,.55),
    0 12px 22px rgba(0,0,0,.35);
}
.word.inSentence{
  box-shadow:var(--slotGlow);
  background:#fff7cf;
  color:#000;
}

/* buttons */
.btn{
  display:block;
  margin:16px auto 8px;
  border:none;
  border-radius:999px;
  padding:16px 36px;
  font-weight:900;
  font-size:clamp(18px,4vw,22px);
  cursor:pointer;
}
.btn.green{
  background:radial-gradient(circle at 30% 30%,#1ee99a,#15c473,#0ea85d);
  color:#00230f;
  box-shadow:0 0 0 5px rgba(34,197,94,.22),0 0 18px rgba(34,197,94,.8);
}
.btn.blue{
  background:radial-gradient(circle at 30% 30%,#66b3ff,#1e6eff);
  color:#00163a;
  box-shadow:0 0 0 5px rgba(102,179,255,.22),0 0 18px rgba(102,179,255,.8);
}
.btn:disabled{opacity:.45;cursor:not-allowed}
.btn.small{margin:0;padding:12px 20px;font-size:clamp(16px,3.6vw,18px);}
.btn.gold{
  background:linear-gradient(135deg,#c59b10 0%,#ffd95e 40%,#ffe898 60%,#b68006 100%);
  color:#2a1b00;
  box-shadow:0 0 0 5px rgba(255,214,120,.18), 0 0 18px rgba(255,214,120,.55);
}

/* big FX */
.bigFx{
  position:fixed;
  left:50%; top:52%;
  transform:translate(-50%,-50%) scale(.6);
  opacity:0;
  pointer-events:none;
  z-index:9999;
  filter:drop-shadow(0 0 18px rgba(255,255,255,.22));
  will-change:transform,opacity;
}
.bigFx.show{animation:bigPop 900ms ease-out both;}
@keyframes bigPop{
  0%{opacity:0;transform:translate(-50%,-50%) scale(.6)}
  20%{opacity:1;transform:translate(-50%,-54%) scale(1.25)}
  100%{opacity:0;transform:translate(-50%,-64%) scale(1.55)}
}
.bigFx svg{width:140px;height:140px;display:block;}

/* results glow colors */
.redGlow{background:#5c0000;}
.orangeGlow{background:#773b00;}
.blueGlow{background:#001b5f;}
.goldGlow{background:#5a4600;}
.confetti{position:fixed;width:10px;height:14px;top:-10px;animation:fall linear forwards;z-index:9998}
@keyframes fall{
  0%{transform:translateY(-10px) rotate(0deg);}
  100%{transform:translateY(110vh) rotate(720deg);}
}

.end{
  position:fixed;
  inset:0;
  display:none;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  text-align:center;
  padding:24px 16px;
}
.end .msg{font-weight:900;font-size:clamp(26px,6vw,42px);}
.end .score{font-weight:900;font-size:clamp(22px,5vw,30px);margin:10px auto 20px;}
footer{text-align:center;color:#c9d4ec;font-family:'Cinzel',serif;font-weight:700;padding:40px 10px}

/* Quit – smaller Booha version */
.top-nav-btn{
  position:fixed;
  top:8px;
  left:8px;
  z-index:12001;
  border-radius:999px;
  padding:3px 8px;
  border:1px solid #ffffff66;
  background:rgba(15,23,42,.95);
  color:#fff;
  font-size:0.55rem;
  font-weight:700;
  letter-spacing:.04em;
  cursor:pointer;
  display:flex;
  align-items:center;
  gap:3px;
  box-shadow:0 0 8px rgba(0,0,0,.6);
  backdrop-filter:blur(4px);
}
.top-nav-btn .jp{
  font-size:0.48rem;
  line-height:1;
  font-weight:700;
  opacity:.9;
  transform:translateY(1px);
}

/* Help button */
.help-btn{
  position:fixed; top:8px; right:8px; z-index:12001;
  width:34px; height:34px; border-radius:999px;
  border:1px solid #ffffff88;
  background:radial-gradient(circle at 30% 30%,#7dd3fc,#1e3a8a 65%,#020617 100%);
  color:#fff; font-weight:900; font-size:18px;
  cursor:pointer; display:flex; align-items:center; justify-content:center;
  box-shadow:0 0 12px rgba(125,211,252,.9),0 0 28px rgba(59,130,246,.9),0 0 52px rgba(56,189,248,.9);
  backdrop-filter:blur(4px);
}
.help-btn:active{transform:scale(.95)}

/* Help modal */
.help-modal{position:fixed; inset:0; z-index:12000; display:none; align-items:center; justify-content:center;}
.help-modal.show{display:flex;}
.help-backdrop{position:absolute; inset:0; background:rgba(15,23,42,.8); backdrop-filter:blur(6px);}
.help-dialog{
  position:relative; z-index:1;
  max-width:720px; width:calc(100% - 32px); max-height:80vh;
  border-radius:20px; border:1px solid #ffffff33;
  background:radial-gradient(circle at top,#111827,#020617 55%);
  box-shadow:0 22px 70px rgba(0,0,0,.9);
  padding:18px 18px 20px;
  display:flex; flex-direction:column;
}
.help-dialog h2{font-family:'Cinzel',serif;font-size:1.2rem;text-align:center;margin-bottom:6px}
.help-sub{font-size:.85rem;text-align:center;color:#c7d2fe;margin-bottom:10px}
.help-body{
  margin-top:6px;
  padding-right:4px;
  font-size:.9rem;
  line-height:1.6;
  color:#e5e7f5;
  overflow-y:auto;
  -webkit-overflow-scrolling:touch;
}
.help-body h3{font-size:.9rem;margin:10px 0 4px;color:#bfdbfe}
.help-body ul{padding-left:1.1rem;margin:4px 0 10px}
.help-body li{margin-bottom:4px}
.help-close{position:absolute;top:8px;right:10px;border:none;background:transparent;color:#e5e7f5;font-size:22px;cursor:pointer}

/* Answer Help Popup */
.ans-modal{position:fixed; inset:0; z-index:12010; display:none; align-items:center; justify-content:center;}
.ans-modal.show{display:flex;}
.ans-dialog{
  position:relative; z-index:1;
  max-width:760px; width:calc(100% - 32px);
  border-radius:22px; border:1px solid #ffffff33;
  background:radial-gradient(circle at top,#111827,#020617 62%);
  box-shadow:0 22px 70px rgba(0,0,0,.92);
  padding:18px 18px 20px;
}
.ans-title{
  font-family:'Cinzel',serif;
  font-weight:900;
  text-align:center;
  font-size:1.1rem;
  margin:2px 0 10px;
}
.ans-en{
  text-align:center;
  font-weight:900;
  font-size:clamp(22px,5.2vw,34px);
  line-height:1.25;
  color:#ffffff;
  text-shadow:0 2px 14px rgba(255,255,255,.14);
  margin:6px 0 10px;
}
.ans-jp{
  text-align:center;
  font-weight:800;
  font-size:clamp(16px,4.4vw,22px);
  color:#cfe1ff;
  margin:0 0 4px;
}
.ans-hi{
  text-align:center;
  font-weight:700;
  font-size:clamp(14px,3.8vw,18px);
  color:#a9c3ff;
  opacity:.95;
  margin:0 0 14px;
}
.ans-actions{
  display:flex;
  gap:12px;
  justify-content:center;
  flex-wrap:wrap;
}
.ans-close{
  position:absolute; top:8px; right:10px;
  border:none; background:transparent; color:#e5e7f5;
  font-size:22px; cursor:pointer;
}

@media (max-width:480px){
  .help-dialog{max-height:82vh;padding:16px 14px 18px;}
  .jpText{font-size:38px;}
}
</style>
</head>

<body>

<button type="button" id="quitBtn" class="top-nav-btn">
  <span>Quit</span><span class="jp">／ やめる</span>
</button>
<button id="helpBtn" type="button" class="help-btn">?</button>

<header>
  <div class="h1">THE BOO-RICULUM</div>
  <div class="h2">MAKE THE SENTENCES</div>

  <!-- //* CHANGE 2/7: Week label text shown on page *// -->
  <div class="h3">January Week 4 – Sentences</div>
  <div class="h4">１月第4週 – 文の練習</div>
</header>

<div class="wrap" id="page-round">
  <div class="panel" id="panel">
    <div class="jpCard locked" id="jpCard" aria-label="Replay audio after correct">
      <div id="jp" class="jpText"></div>
    </div>
    <div id="hira" class="hira"></div>

    <div id="bank" class="wordbank"></div>
    <div id="sentence" class="sentence"></div>

    <button id="checkBtn" class="btn green" disabled>Check</button>

    <div id="nextWrap" style="text-align:center;display:none">
      <button id="nextBtn" class="btn blue">Next</button>
    </div>

    <div id="progress" style="text-align:center;opacity:.9;font-weight:800;margin-top:6px">1 / 15</div>
  </div>
</div>

<!-- Help popup (JP -> EN) -->
<div id="helpModal" class="help-modal" aria-hidden="true">
  <div class="help-backdrop" data-close-help></div>
  <div class="help-dialog">
    <button class="help-close" type="button" data-close-help>×</button>
    <h2>遊び方 ／ HOW TO PLAY</h2>
    <div class="help-sub">Booha Make the Sentences</div>
    <div class="help-body">
      <h3>日本語（先にこちら）</h3>
      <ul>
        <li>上の<strong>日本語の文</strong>（＋ひらがなヒント）を見ます。</li>
        <li>下の白い単語タイルを<strong>タップ</strong>して、グレーのエリアに入れて文を作ります。</li>
        <li>グレーのエリアの単語をタップすると、単語バンクに戻ります。</li>
        <li><strong>並べ替え</strong>：グレーの中の単語をタップして選んでから、別の単語をタップすると、その前に入ります。</li>
        <li>できたら <strong>Check</strong> を押します。</li>
        <li>正解：大きいハート → ding → 音声 → Next</li>
        <li>不正解：大きいおなら → fart → タイルが戻るので、もう一度ならべ直します（点数は増えません）。</li>
        <li>同じ文を<strong>3回連続でまちがえた</strong>ときは、答えのヒント画面が出ます。</li>
        <li>正解のあと、上の日本語カードをタップすると、音声をもう一度聞けます。</li>
      </ul>

      <h3>English</h3>
      <ul>
        <li>Look at the <strong>Japanese sentence</strong> (and the hiragana hint).</li>
        <li><strong>Tap</strong> the word tiles to move them into the gray sentence area.</li>
        <li>Tap a word in the sentence area to send it back to the bank.</li>
        <li><strong>Reorder</strong>: tap a word in the sentence area, then tap another word to insert it before that word.</li>
        <li>Tap <strong>Check</strong> when you finish.</li>
        <li>Correct: big heart → ding → voice → Next</li>
        <li>Wrong: big fart → fart → tiles return, try again (no point).</li>
        <li>If you get the same sentence wrong <strong>3 times in a row</strong>, an answer help screen appears.</li>
        <li>After a correct answer, tap the Japanese card to replay the voice.</li>
      </ul>
    </div>
  </div>
</div>

<!-- Answer Help Popup -->
<div id="ansModal" class="ans-modal" aria-hidden="true">
  <div class="help-backdrop" data-close-ans></div>
  <div class="ans-dialog">
    <button class="ans-close" type="button" data-close-ans>×</button>
    <div class="ans-title">ANSWER HELP</div>
    <div id="ansEn" class="ans-en"></div>
    <div id="ansJp" class="ans-jp"></div>
    <div id="ansHi" class="ans-hi"></div>

    <div class="ans-actions">
      <button id="ansSpeakBtn" class="btn small gold" type="button">Hear it</button>
      <button id="ansCloseBtn" class="btn small blue" type="button">Close / Try again</button>
    </div>
  </div>
</div>

<!-- Results page -->
<div id="page-results" class="end">
  <div class="msg" id="resultMsg"></div>
  <div class="score" id="resultScore"></div>
  <button class="btn blue" id="backToMenuBtn">Back to Main Menu</button>
  <footer style="opacity:.8">Bryan’s English School</footer>
</div>

<!-- Big FX nodes -->
<div class="bigFx" id="bigHeart" aria-hidden="true">
  <svg viewBox="0 0 128 128" aria-hidden="true" focusable="false">
    <path d="M64 112S14 84 14 44c0-16 12-28 28-28 10 0 18 5 22 12 4-7 12-12 22-12 16 0 28 12 28 28 0 40-50 68-50 68Z" fill="#ff3b6e"/>
    <path d="M64 112S14 84 14 44c0-16 12-28 28-28 10 0 18 5 22 12 4-7 12-12 22-12 16 0 28 12 28 28 0 40-50 68-50 68Z" fill="none" stroke="#ffffff" stroke-opacity=".7" stroke-width="4"/>
  </svg>
</div>

<div class="bigFx" id="bigFart" aria-hidden="true">
  <svg viewBox="0 0 128 128" aria-hidden="true" focusable="false">
    <g fill="#cbd5e1">
      <path d="M44 92c-14 0-26-10-26-23 0-11 8-20 19-22 3-13 15-23 30-23 12 0 23 6 28 16 10 1 18 10 18 21 0 12-10 21-22 21H44Z"/>
    </g>
    <g fill="none" stroke="#ffffff" stroke-opacity=".65" stroke-width="4" stroke-linecap="round">
      <path d="M28 50c-8-10-2-22 10-26"/>
      <path d="M92 44c6-10 18-12 24-4"/>
      <path d="M78 98c12 4 20 14 18 22"/>
    </g>
  </svg>
</div>

<footer>Bryan’s English School</footer>

<!-- SFX + results (paths set by JS so it works from root OR inside /week1/) -->
<audio id="s_ding"  preload="auto" playsinline></audio>
<audio id="s_fart"  preload="auto" playsinline></audio>
<audio id="s_r05"   preload="auto" playsinline></audio>
<audio id="s_r610"  preload="auto" playsinline></audio>
<audio id="s_r1114" preload="auto" playsinline></audio>
<audio id="s_r15"   preload="auto" playsinline></audio>

<!-- Sage player (single element, reliable) -->
<audio id="sageVoice" preload="auto" playsinline></audio>

<script>
/* =========================
   //* CHANGE 3/7: Week folder prefix (ONLY change week number)
   ========================= */
const WEEK_FOLDER = 'week4';
const WEEK_PREFIX = location.pathname.includes('/' + WEEK_FOLDER + '/') ? '' : (WEEK_FOLDER + '/');

/* =========================
   //* CHANGE 5/7: Audio paths (usually never change)
   ========================= */
function setAudioSrc(id, relPath){
  const el = document.getElementById(id);
  if(!el) return;
  el.src = WEEK_PREFIX + relPath;
}
function initAudioPaths(){
  setAudioSrc('s_ding',  'assets/audio/ding.mp3');
  setAudioSrc('s_fart',  'assets/audio/fart.mp3');
  setAudioSrc('s_r05',   'assets/audio/result_0-5.mp3');
  setAudioSrc('s_r610',  'assets/audio/result_6-10.mp3');
  setAudioSrc('s_r1114', 'assets/audio/result_11-14.mp3');
  setAudioSrc('s_r15',   'assets/audio/result_15.mp3');
}
initAudioPaths();

/* =========================
   //* CHANGE 4/7: Sentence data (id 1..15 matches s01_.. s15_..)
   ========================= */
const BASE_DATA = [
  { id: 1,  en: "I want to learn English.", 
    jp: "英語を学びたいです。", 
    hira: "えいご を まなびたい です" },

  { id: 2,  en: "I want to try harder.", 
    jp: "もっとがんばりたいです。", 
    hira: "もっと がんばりたい です" },

  { id: 3,  en: "I want to read more books.", 
    jp: "もっと本を読みたいです。", 
    hira: "もっと ほん を よみたい です" },

  { id: 4,  en: "I want to make new friends.", 
    jp: "新しい友だちを作りたいです。", 
    hira: "あたらしい ともだち を つくりたい です" },

  { id: 5,  en: "I can do my best.", 
    jp: "ベストをつくせます。", 
    hira: "べすと を つくせます" },

  { id: 6,  en: "I can speak a little English.", 
    jp: "少し英語を話せます。", 
    hira: "すこし えいご を はなせます" },

  { id: 7,  en: "I can understand songs in English.", 
    jp: "英語の歌が分かります。", 
    hira: "えいご の うた が わかります" },

  { id: 8,  en: "I can help my classmates.", 
    jp: "クラスメートを手伝えます。", 
    hira: "くらすめーと を てつだえます" },

  { id: 9,  en: "I’m good at drawing.", 
    jp: "絵をかくのが得意です。", 
    hira: "え を かく の が とくい です" },

  { id: 10, en: "I’m good at listening.", 
    jp: "聞くのが得意です。", 
    hira: "きく の が とくい です" },

  { id: 11, en: "I’m not good at math.", 
    jp: "数学が得意ではありません。", 
    hira: "すうがく が とくい では ありません" },

  { id: 12, en: "I’m good at remembering names.", 
    jp: "名前を覚えるのが得意です。", 
    hira: "なまえ を おぼえる の が とくい です" },

  { id: 13, en: "I’m good at cheering people up.", 
    jp: "人を元気にするのが得意です。", 
    hira: "ひと を げんき に する の が とくい です" },

  { id: 14, en: "I can learn from mistakes.", 
    jp: "失敗から学べます。", 
    hira: "しっぱい から まなべます" },

  { id: 15, en: "I can stay positive.", 
    jp: "前向きでいられます。", 
    hira: "まえむき で いられます" }
];



/* Shuffle question order each refresh */
const DATA = shuffle([...BASE_DATA]);

/* DOM */
const qs = s => document.querySelector(s);
const jp=qs('#jp'), hira=qs('#hira'), bank=qs('#bank'), sent=qs('#sentence');
const jpCard = qs('#jpCard');
const check=qs('#checkBtn'), nextWrap=qs('#nextWrap'), nextBtn=qs('#nextBtn');
const progress=qs('#progress');

const bigHeart = qs('#bigHeart');
const bigFart  = qs('#bigFart');

const sfxDing = qs('#s_ding');
const sfxFart = qs('#s_fart');

const sageVoice = qs('#sageVoice');

const ansModal = qs('#ansModal');
const ansEn = qs('#ansEn');
const ansJp = qs('#ansJp');
const ansHi = qs('#ansHi');
const ansSpeakBtn = qs('#ansSpeakBtn');
const ansCloseBtn = qs('#ansCloseBtn');

let i=0;
let score=0;
let wrongMode=false;
let selectedWord = null;
let locked=false;

let wrongStreak=0;
let solved=false;

let flowToken = 0;
let dingTimer = null;
let sagePrimed = false;
let ansOpen = false;

/* Audio cancel / guard */
function cancelAudioFlow(){
  flowToken++;

  try{ sfxDing.pause(); sfxDing.currentTime = 0; }catch(_){}
  sfxDing.onended = null;

  try{ sageVoice.pause(); sageVoice.currentTime = 0; }catch(_){}
  sageVoice.onended = null;
  sageVoice.onerror = null;

  if(dingTimer){ clearTimeout(dingTimer); dingTimer = null; }
}

/* =========================
   //* CHANGE 6/7: Sage sentence filename rule
   - week#/audio/sentences/s01_i_will_study_every_day.mp3
   ========================= */
function slugFromSentence(en){
  return (en||'')
    .toLowerCase()
    .trim()
    .replace(/[’‘´`]/g,"'")
    .replace(/\b(i'm|i’m)\b/g,'im')
    .replace(/\b(can't|can’t)\b/g,'cant')
    .replace(/\b(won't|won’t)\b/g,'wont')
    .replace(/[^a-z0-9]+/g,'_')
    .replace(/^_+|_+$/g,'');
}
function sNum(n){ return String(n).padStart(2,'0'); }
function sagePathForIndex(idx){
  const item = DATA[idx];
  const id = item?.id ?? (idx+1);
  const slug = slugFromSentence(item?.en || '');
  return `${WEEK_PREFIX}audio/sentences/s${sNum(id)}_${slug}.mp3`;
}
async function primeSage(){
  if(sagePrimed) return;
  sagePrimed = true;
  try{
    sageVoice.muted = true;
    sageVoice.src = sagePathForIndex(0);
    const p = sageVoice.play();
    if(p && p.then) await p;
    sageVoice.pause();
    sageVoice.currentTime = 0;
    sageVoice.muted = false;
  }catch(_){
    sageVoice.muted = false;
  }
}
function playSageForIndex(idx, onEnd){
  const src = sagePathForIndex(idx);
  const myToken = flowToken;
  let done=false;

  const finish = ()=>{
    if(done) return;
    done=true;
    sageVoice.onended=null; sageVoice.onerror=null;
    if(onEnd) onEnd();
  };

  sageVoice.onended = ()=>{ if(myToken!==flowToken) return; finish(); };
  sageVoice.onerror = ()=>{ if(myToken!==flowToken) return; finish(); };

  try{
    sageVoice.src = src;
    sageVoice.currentTime = 0;
    const p = sageVoice.play();
    if(p && p.catch) p.catch(()=>{ if(myToken!==flowToken) return; finish(); });
  }catch(_){
    finish();
  }

  setTimeout(()=>{ if(myToken!==flowToken) return; finish(); }, 9000);
}

/* UI helpers */
function chipColor(n){
  const c=["#ff6ec7","#5ee6ff","#ffd166","#8aff80","#c77dff","#fff680","#ff9a8b","#9bffb7","#7cc6ff","#f7a6ff"];
  return c[n%c.length];
}
function updateProgress(){ progress.textContent=`${i+1} / ${DATA.length}`; }
function showBig(el){
  el.classList.remove('show');
  void el.offsetWidth;
  el.classList.add('show');
  setTimeout(()=>el.classList.remove('show'), 950);
}
function setSelected(w){
  clearSelected();
  selectedWord = w;
  if(selectedWord) selectedWord.classList.add('selected');
}
function clearSelected(){
  if(selectedWord) selectedWord.classList.remove('selected');
  selectedWord = null;
}
function refreshCheckState(){
  if(solved || ansOpen) { check.disabled = true; return; }
  check.disabled = (bank.querySelectorAll('.word').length !== 0) || locked;
}
function moveToBank(word){
  word.classList.remove('inSentence','selected');
  bank.appendChild(word);
  refreshCheckState();
}
function moveToSentence(word, beforeEl=null){
  word.classList.add('inSentence');
  word.classList.remove('selected');
  if(beforeEl && beforeEl.parentElement === sent){
    sent.insertBefore(word, beforeEl);
  }else{
    sent.appendChild(word);
  }
  refreshCheckState();
}
function lockTiles(on){
  [...document.querySelectorAll('.word')].forEach(w=>w.disabled = !!on);
}
function lockUI(on){
  locked = !!on;
  lockTiles(locked || ansOpen);
  refreshCheckState();
}

/* Answer Help Popup */
function openAnswerHelp(){
  ansOpen = true;
  cancelAudioFlow();
  primeSage();

  const item = DATA[i];
  ansEn.textContent = item.en;
  ansJp.textContent = item.jp;
  ansHi.textContent = item.hira;

  ansModal.classList.add('show');
  ansModal.setAttribute('aria-hidden','false');

  lockTiles(true);
  check.disabled = true;
}
function closeAnswerHelp(){
  ansOpen = false;
  cancelAudioFlow();

  ansModal.classList.remove('show');
  ansModal.setAttribute('aria-hidden','true');

  lockTiles(false);
  refreshCheckState();
}

/* Build round */
function mount(){
  cancelAudioFlow();

  bank.innerHTML='';
  sent.innerHTML='';

  nextWrap.style.display='none';
  check.style.display='block';
  check.disabled=true;

  wrongMode=false;
  clearSelected();
  locked=false;

  wrongStreak=0;
  solved=false;
  ansOpen=false;
  ansModal.classList.remove('show');
  ansModal.setAttribute('aria-hidden','true');

  jpCard.classList.remove('replay');
  jpCard.classList.add('locked');

  const item = DATA[i];
  jp.textContent=item.jp;
  hira.textContent=item.hira;

  const words = item.en.trim().split(/\s+/);
  shuffle(words).forEach((w,idx)=>{
    const b=document.createElement('button');
    b.type='button';
    b.textContent=w;
    b.className='word';
    b.style.setProperty('--color', chipColor(idx));

    b.addEventListener('click',(e)=>{
      e.stopPropagation();
      if(locked || solved || ansOpen) return;

      const parent = b.parentElement;
      if(parent === bank){
        moveToSentence(b);
        clearSelected();
      }else{
        if(selectedWord && selectedWord !== b && selectedWord.parentElement === sent){
          const moving = selectedWord;
          clearSelected();
          moveToSentence(moving, b);
        }else{
          if(b.classList.contains('selected')){
            moveToBank(b);
            clearSelected();
          }else{
            setSelected(b);
          }
        }
      }
    });

    bank.appendChild(b);
  });

  updateProgress();
  refreshCheckState();

  check.onclick = () => {
    primeSage();
    checkLogic();
  };
}

sent.addEventListener('click',(e)=>{ if(e.target === sent) clearSelected(); });
bank.addEventListener('click',(e)=>{ if(e.target === bank) clearSelected(); });

function currentBuilt(){
  return [...sent.querySelectorAll('.word')].map(e=>e.textContent).join(' ').trim();
}
function currentCorrect(){
  return DATA[i].en.trim();
}
function playOnce(el){
  try{ el.pause(); el.currentTime = 0; }catch(_){}
  try{ return el.play(); }catch(_){ return null; }
}
function resetSentenceToBank(){
  [...sent.querySelectorAll('.word')].forEach(ch=> moveToBank(ch));
  clearSelected();
  refreshCheckState();
}

function checkLogic(){
  cancelAudioFlow();
  if(locked || solved || ansOpen) return;

  const correct = currentCorrect();
  const built = currentBuilt();

  if(built === correct){
    solved = true;
    lockUI(true);

    if(!wrongMode) score++;
    showBig(bigHeart);

    wrongStreak = 0;

    check.style.display = 'none';
    nextWrap.style.display = 'none';

    jpCard.classList.remove('locked');
    jpCard.classList.add('replay');

    const myToken = ++flowToken;
    let fired = false;

    const afterDingOnce = ()=>{
      if(fired) return;
      fired = true;

      if(dingTimer){ clearTimeout(dingTimer); dingTimer = null; }
      sfxDing.onended = null;

      if(myToken !== flowToken) return;

      playSageForIndex(i, ()=>{
        if(myToken !== flowToken) return;
        nextWrap.style.display = 'block';
      });
    };

    sfxDing.onended = afterDingOnce;
    const p = playOnce(sfxDing);
    dingTimer = setTimeout(afterDingOnce, 3500);
    if(p && p.catch) p.catch(()=>afterDingOnce());

  }else{
    wrongMode = true;

    showBig(bigFart);
    playOnce(sfxFart);

    wrongStreak++;
    resetSentenceToBank();

    if(wrongStreak >= 3){
      wrongStreak = 0;
      openAnswerHelp();
    }
  }
}

/* Replay Sage after correct (tap JP card) */
jpCard.addEventListener('click', ()=>{
  if(!solved) return;
  cancelAudioFlow();
  primeSage();
  playSageForIndex(i);
});

nextBtn.onclick = () => {
  cancelAudioFlow();
  i++;
  if(i >= DATA.length) return finish();
  mount();
};

/* Results */
function finish(){
  qs('#page-round').style.display='none';
  showResults();
}
function showResults(){
  qs('#page-results').style.display='flex';

  const totalScore = score;
  const pct = Math.round((totalScore/15)*100);

  const msgEl = qs('#resultMsg');
  const scoreEl= qs('#resultScore');

  let bg="blueGlow", msg="いいね！あと少しでパーフェクト！", snd=qs('#s_r1114');
  if(totalScore<=5){ bg="redGlow"; msg="ブーリキュラム見てないでしょ！"; snd=qs('#s_r05'); }
  else if(totalScore<=10){ bg="orangeGlow"; msg="YouTube見すぎ！ブーリキュラムもやろう！"; snd=qs('#s_r610'); }
  else if(totalScore===15){ bg="goldGlow"; msg="すごい！あなたは地球で一番頭がいい！"; snd=qs('#s_r15'); }

  document.body.className = bg;
  msgEl.textContent = msg;
  scoreEl.textContent = `${totalScore}/15（${pct}%）`;

  const p = playOnce(snd);
  if(p && p.catch) p.catch(()=>{});

  if(totalScore===15){
    for(let k=0;k<160;k++){
      setTimeout(()=>{
        const c=document.createElement('div');
        c.className='confetti';
        c.style.left=(Math.random()*100)+'vw';
        c.style.background=`hsl(${Math.random()*360},100%,60%)`;
        c.style.animationDuration=(0.9+Math.random()*0.9)+'s';
        document.body.appendChild(c);
        setTimeout(()=>c.remove(),1900);
      }, k*10);
    }
  }
}

/* Utils */
function shuffle(a){
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}

/* Help modal */
const helpBtnEl = qs('#helpBtn');
const helpModal = qs('#helpModal');
if(helpBtnEl && helpModal){
  const closeEls = helpModal.querySelectorAll('[data-close-help]');
  const openHelp = ()=>{ helpModal.classList.add('show'); helpModal.setAttribute('aria-hidden','false'); };
  const closeHelp= ()=>{ helpModal.classList.remove('show'); helpModal.setAttribute('aria-hidden','true'); };
  helpBtnEl.addEventListener('click', openHelp);
  closeEls.forEach(el=>el.addEventListener('click', closeHelp));
  helpModal.addEventListener('click', e=>{ if(e.target===helpModal) closeHelp(); });
  document.addEventListener('keydown', e=>{ if(e.key==='Escape') closeHelp(); });
}

/* Answer popup controls */
ansSpeakBtn.addEventListener('click', (e)=>{
  e.preventDefault();
  e.stopPropagation();
  if(!ansOpen) return;
  cancelAudioFlow();
  primeSage();
  playSageForIndex(i);
});
function closeAnsFromUI(){ closeAnswerHelp(); }
ansCloseBtn.addEventListener('click', closeAnsFromUI);
ansModal.querySelectorAll('[data-close-ans]').forEach(el=> el.addEventListener('click', closeAnsFromUI));
ansModal.addEventListener('click', (e)=>{ if(e.target === ansModal) closeAnsFromUI(); });
document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape' && ansOpen) closeAnsFromUI(); });

/* Menu buttons */
qs('#quitBtn').addEventListener('click', ()=>{ window.location.href = 'index.html'; });
qs('#backToMenuBtn').addEventListener('click', ()=>{ window.location.href = 'index.html'; });

/* =========================
   //* CHANGE 7/7: Boot
   ========================= */
mount();
</script>

</body>
</html>
