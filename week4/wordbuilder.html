<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Booha Word Builder ‚Äì January Week 4</title>

<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Noto+Sans+JP:wght@500;700&display=swap" rel="stylesheet">

<style>
/* ///*** =========================================================
   ///*** [A] WEEKLY THEME COLORS (CHANGE EACH WEEK IF YOU WANT)
   ///*** ========================================================= */
:root{
  --bg:#0b1530; --ink:#fff; --outline:#ffffff26;
  --green:#22c55e; --red:#ef4444; --purple:#7c3aed;
  --gold:#ffd54a; --goldSoft:#ffe59966;
  --tile:#1b2046;
}

*{box-sizing:border-box;margin:0;padding:0}

body{
  background:var(--bg); color:var(--ink);
  font-family:system-ui,'Noto Sans JP',sans-serif;
  min-height:100vh; display:flex; flex-direction:column;
  overflow-x:hidden; overflow-y:auto;
  user-select:none; -webkit-user-select:none; -ms-user-select:none;
}

/* ///*** =========================================================
   ///*** [B] TOP NAV + HELP UI (STANDARD BOOHA)
   ///*** ========================================================= */

/* Top nav buttons (standard Booha) */
.top-nav-btn{
  position:fixed; top:10px; left:10px; z-index:60;
  border-radius:999px; padding:6px 14px;
  border:1px solid #ffffff66;
  background:rgba(15,23,42,.95);
  color:#fff; font-size:.78rem; font-weight:700; letter-spacing:.04em;
  cursor:pointer; display:flex; align-items:center; gap:4px;
  box-shadow:0 0 12px rgba(0,0,0,.6);
  backdrop-filter:blur(4px);
}
.top-nav-btn span.jp{font-family:'Noto Sans JP',sans-serif;font-size:.74em}

/* Help "?" button */
.icon-btn{
  position:fixed; top:10px; right:10px;
  width:34px; height:34px; border-radius:999px;
  border:1px solid #ffffff66;
  background:radial-gradient(circle at 30% 30%,#ffffffee,#38bdf8cc,#4f46e5ff);
  color:#0b1530; font-weight:900; font-size:1.15rem;
  display:flex; align-items:center; justify-content:center;
  cursor:pointer;
  box-shadow:0 0 16px rgba(96,165,250,.9),0 0 32px rgba(129,140,248,.75);
  backdrop-filter:blur(6px);
  z-index:60;
  animation:helpPulse 1.9s ease-in-out infinite;
}
@keyframes helpPulse{0%,100%{transform:scale(1)}50%{transform:scale(1.06)}}

/* Help modal */
.help-modal{
  position:fixed; inset:0;
  background:rgba(15,23,42,.86);
  backdrop-filter:blur(6px);
  display:none; align-items:center; justify-content:center;
  z-index:80;
}
.help-panel{
  width:min(520px,92vw);
  max-height:80vh;
  background:#020617;
  border-radius:24px;
  border:1px solid #ffffff33;
  box-shadow:0 18px 60px rgba(0,0,0,.85);
  padding:18px 18px 22px;
  overflow-y:auto;
  font-size:.9rem;
  line-height:1.6;
}
.help-panel h2{font-family:'Cinzel',serif;font-size:1.3rem;margin-bottom:4px}
.help-panel h3{font-size:.95rem;opacity:.9;margin-bottom:12px}
.help-panel p{margin-bottom:8px}
.help-panel p.jp{font-family:'Noto Sans JP',sans-serif}
.help-close{
  position:absolute; top:10px; right:14px;
  border:none; background:transparent;
  color:#e5e7eb; font-size:1.2rem; cursor:pointer;
}

/* ///*** =========================================================
   ///*** [C] GLOBAL OVERLAYS / FX
   ///*** ========================================================= */

#overlay{position:fixed; inset:0; pointer-events:none; z-index:9999}
.flashRed{position:fixed; inset:0; background:rgba(255,0,0,.35); animation:flash .35s ease; pointer-events:none; z-index:9998}
@keyframes flash{0%{opacity:0}40%{opacity:1}100%{opacity:0}}

/* ///*** =========================================================
   ///*** [D] HEADER / HERO
   ///*** ========================================================= */

header{
  text-align:center;
  padding:48px 16px 8px;
  position:relative;
  z-index:5;
}
header h1,header h2,header h3{font-family:'Cinzel',serif}
header h2{font-size:clamp(2rem,6vw,3rem);margin-top:4px}
header h3{margin-top:6px;opacity:.9}

/* Play (fizzle behind triangle) */
.playWrap{
  position:relative;
  z-index:10;
  display:flex;
  flex-direction:column;
  align-items:center;
  margin-top:28px;
}
.playBtn{
  appearance:none;border:none;cursor:pointer;width:240px;height:240px;border-radius:50%;
  display:grid;place-items:center;font-size:6rem;font-weight:900;color:#0b1530;
  background:conic-gradient(from 0deg,#ff007f,#ff7f00,#ffff00,#00ff00,#00ffff,#007fff,#ff00ff,#ff007f);
  box-shadow:0 0 80px #ff00ff88,0 0 150px #00ffff66;
  animation:rgbSpin 4s linear infinite,pulse 2s ease-in-out infinite;
  position:relative;overflow:hidden;z-index:11;
}
.playBtn::before,.playBtn::after{content:"";position:absolute;inset:0;border-radius:50%;pointer-events:none}
.playBtn.fizzy::before{
  background:
    radial-gradient(circle at 25% 75%,rgba(255,255,255,.6),transparent 60%),
    radial-gradient(circle at 75% 25%,rgba(255,255,255,.4),transparent 60%),
    radial-gradient(circle at 50% 50%,rgba(255,255,255,.3),transparent 60%);
  animation:fizzmove .35s infinite linear; z-index:0;
}
.playBtn.fizzy::after{
  box-shadow:0 0 40px 10px #fff8,0 0 90px 20px #00ffff99;
  animation:fizzglow .25s ease-in-out infinite alternate; z-index:0;
}
.playBtn span{position:relative;z-index:5;transform:translateX(4px)}
@keyframes rgbSpin{to{filter:hue-rotate(360deg)}}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.08)}}
@keyframes fizzmove{0%{transform:translate(0,0) rotate(0)}50%{transform:translate(-4px,-4px) rotate(180deg)}100%{transform:translate(0,0) rotate(360deg)}}
@keyframes fizzglow{0%{opacity:.4;filter:blur(3px)}100%{opacity:1;filter:blur(7px)}}

/* ///*** =========================================================
   ///*** [E] GAME LAYOUT
   ///*** ========================================================= */

main{
  flex:1;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:18px;
  padding:0 10px 18px;
}

.dropZone,
.bank{
  display:flex;
  flex-wrap:wrap;
  gap:14px;
  justify-content:center;
  align-items:center;
  max-width:100%;
  overflow:visible;
  padding:8px 4px;
}

.slot,.tile{
  border-radius:18px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:900;
  font-size:52px;
  transition:box-shadow .15s, background .15s, transform .12s, filter .12s, color .12s;
  flex:0 0 auto;
}

/* Slightly smaller tiles */
.slot{width:88px;height:88px;border:2px dashed #ffffff3a;background:#27306b99}
.slot.filled{background:#2a2f6b;border-color:#fff9;box-shadow:0 0 12px #facc15, 0 0 28px #fde68a66}
.slot.hint{border-color:#fffbe8;box-shadow:0 0 18px #facc15,0 0 34px #fde68ab3}

.tile{
  width:88px;height:88px;
  background:var(--tile);
  border:1px solid #8690ff33;
  box-shadow:0 8px 14px rgba(0,0,0,.28);
  color:#fff;
  cursor:pointer;
  -webkit-tap-highlight-color: transparent;
  touch-action: manipulation;
}

/* Cute glow when touched / selected */
.tile:active{transform:scale(1.04)}
.tile.touched{
  box-shadow:
    0 0 0 2px rgba(255,255,255,.25) inset,
    0 0 20px rgba(244,114,182,.75),
    0 0 42px rgba(167,139,250,.55);
  filter:saturate(1.2) brightness(1.15);
}
.tile.selected{
  background:#2a2f6b;
  box-shadow:
    0 0 0 2px rgba(255,255,255,.18) inset,
    0 0 20px rgba(125,211,252,.8),
    0 0 44px rgba(167,139,250,.65);
  transform:translateY(-2px) scale(1.05);
}

/* Tile inside slot */
.slot .tile{width:100%;height:100%;border-radius:16px}
.tile.inSlot{background:#fff4c2;color:#000;box-shadow:0 0 18px #facc15,0 0 32px #fde68a66}

.controls{display:flex;gap:12px;justify-content:center;margin-top:10px}
.btn{appearance:none;border:none;cursor:pointer;padding:12px 20px;border-radius:14px;font-weight:800;font-size:16px}
.btn.primary{background:linear-gradient(135deg,#a78bfa,#7c3aed);color:#fff;box-shadow:0 0 20px #7c3aed66}

#nextWrap{display:none;flex-direction:column;align-items:center;margin-top:14px}
#nextBtn{
  appearance:none;border:none;cursor:pointer;
  padding:12px 24px;border-radius:14px;font-weight:900;font-size:18px;color:#fff;
  background:linear-gradient(135deg,#22c55e,#16a34a);
  box-shadow:0 0 20px #16a34a80,0 0 40px #22c55e55;
  animation:nextPulse 1.4s ease-in-out infinite;
}
@keyframes nextPulse{0%,100%{transform:scale(1)}50%{transform:scale(1.06)}}
#progressCount{margin-top:10px;font-weight:700;font-size:1.1rem}

/* ONE big heart + ONE big fart cloud */
.bigFx{
  position:fixed;
  left:50%; top:52%;
  transform:translate(-50%,-50%) scale(.6);
  opacity:0;
  pointer-events:none;
  z-index:9999;
  filter:drop-shadow(0 0 18px rgba(255,255,255,.22));
  will-change:transform,opacity;
}
.bigFx.show{
  animation:bigPop 900ms ease-out both;
}
@keyframes bigPop{
  0%{opacity:0;transform:translate(-50%,-50%) scale(.6)}
  20%{opacity:1;transform:translate(-50%,-54%) scale(1.25)}
  100%{opacity:0;transform:translate(-50%,-64%) scale(1.55)}
}

/* Results */
#page-results{
  display:none;
  text-align:center;
  padding:60px 16px;
  min-height:60vh;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:22px;
}
#page-results h2{font-family:'Cinzel',serif;}
#resultMsg{font-size:clamp(1.6rem,4vw,2rem);font-weight:900;text-shadow:0 0 10px rgba(255,255,255,.2)}
#resultScore{font-size:clamp(1.4rem,3.5vw,1.8rem);font-weight:700}
.redGlow{background:#2b0b0b}
.orangeGlow{background:#2b1a0b}
.blueGlow{background:#0b1530}
.goldGlow{background:#2b210b}
.confetti{position:fixed;top:-10vh;width:10px;height:16px;border-radius:2px;animation:fall linear both;z-index:9999}
@keyframes fall{to{transform:translateY(110vh) rotate(720deg)}}

footer{text-align:center;padding:16px;font-family:'Cinzel',serif;font-size:.95rem;opacity:.85;border-top:1px solid var(--outline)}

@media (max-width:600px){
  .slot,.tile{font-size:38px}
  .slot{width:62px;height:62px;border-radius:14px}
  .tile{width:62px;height:62px;border-radius:14px}
  .slot .tile{border-radius:12px}
  .dropZone,.bank{gap:10px}
  header{padding-top:56px}
  .playBtn{width:210px;height:210px;font-size:5.2rem}
}
</style>
</head>

<body>
<div id="overlay"></div>

<button class="top-nav-btn" id="quitBtn"><span>Quit</span><span class="jp">„ÇÑ„ÇÅ„Çã</span></button>
<button class="icon-btn" id="helpBtn">?</button>

<div class="help-modal" id="helpModal" aria-hidden="true">
  <div class="help-panel" role="dialog" aria-modal="true" aria-label="How to Play">
    <button class="help-close" id="helpClose" aria-label="Close">√ó</button>
    <h2>ÈÅä„Å≥Êñπ / How to Play</h2>
    <h3>Word Builder Game</h3>

    <p class="jp">ÔºëÔºé„É¨„Ç§„É≥„Éú„Éº„ÅÆ‰∏∏„ÅÑ„Éú„Çø„É≥Ôºà‚ñ∂Ôºâ„Çí„Çø„ÉÉ„Éó„Åó„Å¶„ÄÅËã±ÂçòË™û„ÇíËÅû„Åç„Åæ„Åô„ÄÇ</p>
    <p class="jp">ÔºíÔºé‰∏ã„ÅÆ„Ç¢„É´„Éï„Ç°„Éô„ÉÉ„Éà„Çí„Äå„Çø„ÉÉ„Éó„Äç„Åó„Å¶„ÄÅ‰∏ä„ÅÆ„Éû„Çπ„Å´ÂÖ•„Çå„Å¶ÂçòË™û„Çí‰Ωú„Çä„Åæ„Åô„ÄÇ</p>
    <p class="jp">Ôºà‚Äª„Çø„Ç§„É´„ÇíÂÖà„Å´„Çø„ÉÉ„Éó ‚Üí ÂÖ•„Çå„Åü„ÅÑ„Éû„Çπ„Çí„Çø„ÉÉ„Éó „Åß„ÇÇOKÔºÅÔºâ</p>
    <p class="jp">ÔºìÔºé„Åô„Åπ„Å¶„ÅÆ„Éû„Çπ„Åå„ÅÜ„Åæ„Å£„Åü„Çâ„ÄåCHECK„Äç„ÇíÊäº„Åó„Åæ„Åô„ÄÇ</p>
    <p class="jp">ÔºîÔºéÔºëÂõûÁõÆ„ÅßÊ≠£Ëß£„Åô„Çã„Å®Ôºë„Éù„Ç§„É≥„ÉàÔºÅ„Åæ„Å°„Åå„Åà„Åü„Çâ„Çø„Ç§„É´„Åå„ÇÇ„Å©„Çã„ÅÆ„Åß„ÄÅ„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÉÅ„É£„É¨„É≥„Ç∏„Åß„Åç„Åæ„ÅôÔºà„Åù„ÅÆÂçòË™û„ÅÆ„Éù„Ç§„É≥„Éà„ÅØÔºêÁÇπÔºâ„ÄÇ</p>
    <p class="jp">ÔºïÔºéÂÖ®ÈÉ®„ÅßÔºëÔºïÂïè„ÅÇ„Çä„Åæ„Åô„ÄÇ„Éë„Éº„Éï„Çß„ÇØ„Éà„Çπ„Ç≥„Ç¢„ÇíÁõÆÊåá„Åó„Å¶„Å≠ÔºÅ</p>

    <p>1. Tap the rainbow circle ‚ñ∂ to hear the English word.</p>
    <p>2. Tap the letter tiles to put them into the empty slots (no dragging!).</p>
    <p>(Tip: Tap a tile first, then tap the slot you want.)</p>
    <p>3. When all slots are filled, tap CHECK.</p>
    <p>4. Correct on the first try = 1 point. If you miss, the letters return and you can try again (no point).</p>
    <p>5. There are 15 words. Try to get a perfect score!</p>
  </div>
</div>

<header>
  <h1>THE BOO-RICULUM</h1>
  <h2>WORD BUILDER</h2>
  <h3>February Week 4 ‚Äì 2ÊúàÁ¨¨4ÈÄ±</h3>
</header>

<div class="playWrap" id="playWrap">
  <button class="playBtn" id="playBtn" aria-label="Play audio"><span>‚ñ∂</span></button>
</div>

<main id="page-round">
  <div class="dropZone" id="dropZone"></div>
  <div class="bank" id="bank"></div>

  <div class="controls">
    <button class="btn primary" id="checkBtn" disabled>CHECK</button>
  </div>

  <div id="nextWrap"><button id="nextBtn">Next / „Å§„Åé„Å∏</button></div>
  <div id="progressCount">1 / 15</div>
</main>

<section id="page-results">
  <h2>RESULTS / „É™„Ç∂„É´„Éà</h2>
  <div id="resultMsg">„ÅÑ„ÅÑ„Å≠ÔºÅ„ÅÇ„Å®Â∞ë„Åó„Åß„Éë„Éº„Éï„Çß„ÇØ„ÉàÔºÅ</div>
  <div id="resultScore">0/15Ôºà0%Ôºâ</div>
</section>

<!-- Big FX nodes (single heart + single fart cloud) -->
<div class="bigFx" id="bigHeart" aria-hidden="true" style="font-size:120px;">‚ù§Ô∏è</div>
<div class="bigFx" id="bigFart" aria-hidden="true" style="font-size:120px;">üí®</div>

<footer>BRYAN'S ENGLISH SCHOOL</footer>

<script>
/* ///*** =========================================================
   ///*** [1] WEEK CONFIG (EDIT HERE EACH WEEK)
   ///*** ========================================================= */
const WEEK_CONFIG = {
  monthEn: "January",
  monthJp: "1Êúà",
  weekEn: "Week 4",
  weekJp: "Á¨¨4ÈÄ±",
  totalQuestions: 15,

 /* ‚úÖ WEEK DATA (CHANGE EACH WEEK) */
MASTER_BASE: [
  "mind","heart","focus","relax","try",
  "learn","mistake","improve","believe","effort",
  "success","attitude","courage","goal","happy"
],
};

/* ///*** =========================================================
   ///*** [2] PATHS (AUTO) ‚Äî NO MORE "week4/" HACKS
   ///*** =========================================================
   Works anywhere as long as the folder contains:
     ./audio/vocab/...
     ./assets/audio/...
*/
const BASE = (() => {
  const u = new URL(window.location.href);
  u.hash = ""; u.search = "";
  return u.href.endsWith("/") ? u.href : u.href.replace(/[^/]+$/, "");
})();
const PATHS = {
  vocab: BASE + "audio/vocab/",
  sfx:   BASE + "assets/audio/"
};

/* ///*** =========================================================
   ///*** [3] HELPERS / DOM SHORTCUTS
   ///*** ========================================================= */
const $ = (s) => document.querySelector(s);

/* ///*** =========================================================
   ///*** [4] DOM HOOKS
   ///*** ========================================================= */
const drop=$("#dropZone"), bank=$("#bank"), play=$("#playBtn"), check=$("#checkBtn");
const nextWrap=$("#nextWrap"), nextBtn=$("#nextBtn"), progressCount=$("#progressCount");
const pageRound=$("#page-round"), pageResults=$("#page-results");
const playWrap=$("#playWrap");
const quitBtn=$("#quitBtn");
const helpBtn=$("#helpBtn"), helpModal=$("#helpModal"), helpClose=$("#helpClose");
const bigHeart=$("#bigHeart"), bigFart=$("#bigFart");

/* ///*** =========================================================
   ///*** [5] NAV / HELP (EDIT ONLY IF MENU PATH CHANGES)
   ///*** ========================================================= */
quitBtn.addEventListener("click",()=>{ location.href="index.html"; });

function openHelp(){ helpModal.style.display="flex"; helpModal.setAttribute("aria-hidden","false"); }
function closeHelp(){ helpModal.style.display="none"; helpModal.setAttribute("aria-hidden","true"); }
helpBtn.addEventListener("click",openHelp);
helpClose.addEventListener("click",closeHelp);
helpModal.addEventListener("click",e=>{ if(e.target===helpModal) closeHelp(); });

/* ///*** =========================================================
   ///*** [6] AUDIO ENGINE (NO CLIPPED STARTS / CROSS-DEVICE)
   ///*** =========================================================
   FIXES:
   - "emergency" -> "mergency" (Sage MP3 start clipping)
   - ding late / clipped on iOS
   STRATEGY:
   - One-time unlock on first gesture
   - WebAudio decoded buffers for SFX (ding/fart/results) = instant
   - "Prime" Sage <audio> elements (muted micro-play) after unlock
*/

/* ---------- [6A] WebAudio core (for SFX) ---------- */
let AC = null;                 // AudioContext
let audioUnlocked = false;     // one-time
const SFX_BUFFERS = new Map(); // name -> AudioBuffer

function getAudioContext(){
  if(AC) return AC;
  const Ctx = window.AudioContext || window.webkitAudioContext;
  if(!Ctx) return null;
  AC = new Ctx();
  return AC;
}

async function fetchArrayBuffer(url){
  const res = await fetch(url, { cache:"force-cache" }).catch(()=>null);
  if(!res || !res.ok) throw new Error("fetch failed: " + url);
  return await res.arrayBuffer();
}

async function decodeToBuffer(url){
  const ctx = getAudioContext();
  if(!ctx) return null;
  const ab = await fetchArrayBuffer(url);
  // decodeAudioData sometimes needs callback on older safari, but promises work on modern Safari
  const buf = await ctx.decodeAudioData(ab.slice(0));
  return buf;
}

function playSfxBuffer(name, opts = {}){
  const ctx = getAudioContext();
  if(!ctx) return; // fallback will handle elsewhere
  const buf = SFX_BUFFERS.get(name);
  if(!buf) return;

  const src = ctx.createBufferSource();
  src.buffer = buf;

  const gain = ctx.createGain();
  gain.gain.value = (typeof opts.gain === "number") ? opts.gain : 1.0;

  src.connect(gain);
  gain.connect(ctx.destination);

  // NOTE: For MP3 encoder delay/start, we can optionally skip a tiny amount.
  // Keeping at 0 by default because buffers are decoded and play instantly.
  const offset = (typeof opts.offset === "number") ? opts.offset : 0;
  try{ src.start(0, offset); }catch{}
}

/* ---------- [6B] <audio> fallback (if WebAudio unsupported) ---------- */
const sfxFallback = {
  ding:  new Audio(PATHS.sfx + "ding.mp3"),
  fart:  new Audio(PATHS.sfx + "fart.mp3"),
  r0_5:  new Audio(PATHS.sfx + "result_0-5.mp3"),
  r6_10: new Audio(PATHS.sfx + "result_6-10.mp3"),
  r11_14:new Audio(PATHS.sfx + "result_11-14.mp3"),
  r15:   new Audio(PATHS.sfx + "result_15.mp3"),
};

Object.values(sfxFallback).forEach(a=>{
  a.preload="auto";
  a.playsInline = true;
  a.crossOrigin = "anonymous";
  try{ a.load(); }catch{}
});

function playAudioTag(a){
  try{
    // For iOS: setting currentTime right before play can sometimes stutter.
    // But for short SFX it‚Äôs usually OK once primed.
    a.pause();
    a.currentTime = 0;
    const p = a.play();
    if(p && p.catch){
      p.catch(()=>{
        // last-resort clone (rare)
        const clone = a.cloneNode(true);
        clone.preload="auto";
        clone.playsInline=true;
        clone.play().catch(()=>{});
      });
    }
  }catch{}
}

/* ---------- [6C] Sage voice cache (local MP3s) ---------- */
const sage = new Map();
WEEK_CONFIG.MASTER_BASE.forEach((word, i) => {
  const num = String(i + 1).padStart(2, "0");
  const src = `${PATHS.vocab}v${num}_${word}.mp3`;
  const a = new Audio(src);
  a.preload = "auto";
  a.playsInline = true;
  a.loop = false;
  a.crossOrigin = "anonymous";
  // iOS tip: keep volume at 1, prime via muted micro-play
  try{ a.load(); }catch{}
  sage.set(word, a);
});

function stopAllSage(){
  sage.forEach(a=>{ try{ a.pause(); a.currentTime = 0; }catch{} });
}

/* ---------- [6D] Unlock + Prime (THE IMPORTANT PART) ---------- */
async function primeAudioTag(a){
  // Prime by doing a micro muted play/pause, so the next play won't clip.
  // On iOS, this is the #1 fix for "mergency"/"erections" üôÉ
  try{
    const wasMuted = a.muted;
    const wasVol = a.volume;

    a.muted = true;
    a.volume = 0;

    // play a tiny bit
    const p = a.play();
    if(p && p.catch) await p.catch(()=>{});
    // pause quickly
    a.pause();
    a.currentTime = 0;

    a.volume = wasVol;
    a.muted = wasMuted;
  }catch{
    // ignore
  }
}

async function unlockAudioOnce(){
  if(audioUnlocked) return;
  audioUnlocked = true;

  // Resume AudioContext (SFX path)
  const ctx = getAudioContext();
  if(ctx){
    try{ if(ctx.state === "suspended") await ctx.resume(); }catch{}
  }

  // Prime ONE fallback tag immediately (helps iOS unlock)
  await primeAudioTag(sfxFallback.ding);

  // Prime ALL Sage tags quickly (15 items: fine)
  // This is what prevents the chopped first syllable.
  for(const a of sage.values()){
    await primeAudioTag(a);
  }

  // Decode SFX buffers (best-case latency)
  // If decoding fails, fallback <audio> still works.
  const want = [
    ["ding", PATHS.sfx + "ding.mp3"],
    ["fart", PATHS.sfx + "fart.mp3"],
    ["r0_5", PATHS.sfx + "result_0-5.mp3"],
    ["r6_10", PATHS.sfx + "result_6-10.mp3"],
    ["r11_14", PATHS.sfx + "result_11-14.mp3"],
    ["r15", PATHS.sfx + "result_15.mp3"],
  ];

  if(ctx){
    for(const [name, url] of want){
      try{
        const buf = await decodeToBuffer(url);
        if(buf) SFX_BUFFERS.set(name, buf);
      }catch{
        // ignore; fallback will cover
      }
    }
  }
}

// unlock on first real interaction (best across devices/iframes)
["pointerdown","touchstart","mousedown","keydown"].forEach(evt=>{
  window.addEventListener(evt, unlockAudioOnce, {once:true, passive:true});
});

/* ---------- [6E] Public SFX play function (buffer-first, fallback-second) ---------- */
function playSfx(name){
  const ctx = getAudioContext();
  if(ctx && SFX_BUFFERS.has(name)){
    playSfxBuffer(name);
  }else{
    // fallback tags
    const a = sfxFallback[name];
    if(a) playAudioTag(a);
  }
}

/* ---------- [6F] Speak button (Sage) ---------- */
async function speak(){
  await unlockAudioOnce();

  const word = WORDS[index];
  const a = sage.get(word);
  if(!a){ console.warn("[Sage] missing audio for:", word); return; }

  stopAllSage();
  play.classList.add("fizzy");

  // Important: don‚Äôt spam currentTime resets during buffering
  try{
    a.pause();
    a.currentTime = 0;
  }catch{}

  const clear = ()=> play.classList.remove("fizzy");
  a.onended = clear;

  const p = a.play();
  if(p && p.catch){
    p.catch(err=>{
      console.warn("[Sage] play blocked/missing:", err, a.src);
      clear();
    });
  }
}
play.addEventListener("click", speak);

/* ///*** =========================================================
   ///*** [7] VISUAL FX (RED FLASH + BIG ICON POP)
   ///*** ========================================================= */
function flashRedScreen(){
  const el=document.createElement("div");
  el.className="flashRed";
  document.body.appendChild(el);
  setTimeout(()=>el.remove(),400);
}
function showBig(el){
  el.classList.remove("show");
  void el.offsetWidth; // reflow
  el.classList.add("show");
  setTimeout(()=>el.classList.remove("show"), 950);
}

/* ///*** =========================================================
   ///*** [8] GAME STATE
   ///*** ========================================================= */
let WORDS = [];
let index = 0;
let totalScore = 0;
let firstTry = true;
let selectedTile = null;

/* ///*** =========================================================
   ///*** [9] SLOT/TILE LOGIC (TAP TILE -> TAP SLOT)
   ///*** ========================================================= */
function nextEmptySlot(){
  return [...drop.children].find(s=>!s.firstChild) || null;
}
function allFilled(){
  return [...drop.children].every(s=>s.firstChild);
}
function currentAnswer(){
  return [...drop.children].map(s=>s.firstChild?.textContent ?? "").join("");
}
function enableCheck(){
  check.disabled = !allFilled();
}
function clearSelected(){
  if(selectedTile) selectedTile.classList.remove("selected");
  selectedTile = null;
}
function markHint(){
  [...drop.children].forEach(s=>s.classList.remove("hint"));
  const s = nextEmptySlot();
  if(s) s.classList.add("hint");
}

function makeTile(ch){
  const t=document.createElement("div");
  t.className="tile";
  t.textContent=ch;

  t.addEventListener("pointerdown",()=>{
    t.classList.add("touched");
    setTimeout(()=>t.classList.remove("touched"), 180);
  }, {passive:true});

  t.addEventListener("click", (e)=>{
    e.stopPropagation();

    const inSlot = t.parentElement?.classList.contains("slot");
    if(inSlot){
      sendToBank(t);
      clearSelected();
      markHint();
      enableCheck();
      return;
    }

    if(selectedTile === t){
      const s = nextEmptySlot();
      if(s) placeIntoSlot(t, s);
      clearSelected();
      markHint();
      enableCheck();
      return;
    }

    clearSelected();
    selectedTile = t;
    t.classList.add("selected");
  });

  return t;
}

function buildSlots(w){
  drop.innerHTML="";
  for(let i=0;i<w.length;i++){
    const s=document.createElement("div");
    s.className="slot";

    s.addEventListener("click", ()=>{
      if(!selectedTile) return;
      if(s.firstChild) return;
      if(selectedTile.parentElement !== bank) return;
      placeIntoSlot(selectedTile, s);
      clearSelected();
      markHint();
      enableCheck();
    });

    drop.appendChild(s);
  }
}

function buildBank(w){
  bank.innerHTML="";
  const chars=[...w];
  let scr=[...chars];
  if(chars.length>1){
    do{ scr.sort(()=>Math.random()-.5); } while(scr.join("")===w);
  }
  scr.forEach(ch=> bank.appendChild(makeTile(ch)));
}

function placeIntoSlot(tile,slot){
  if(slot.firstChild) return;
  tile.classList.remove("selected");
  tile.classList.add("inSlot");
  slot.appendChild(tile);
  slot.classList.add("filled");
}

function sendToBank(tile){
  bank.appendChild(tile);
  tile.classList.remove("inSlot","selected");

  [...drop.children].forEach(s=>{
    if(!s.firstChild) s.classList.remove("filled");
    else s.classList.add("filled");
  });
}

/* ///*** =========================================================
   ///*** [10] ROUND / CHECK LOGIC
   ///*** ========================================================= */
check.addEventListener("click", async ()=>{
  await unlockAudioOnce();

  const ans = currentAnswer();
  const correct = WORDS[index];

  if(ans === correct){
    if(firstTry) totalScore++;

    showBig(bigHeart);
    playSfx("ding");              // ‚úÖ buffer-first SFX

    nextWrap.style.display="flex";
    check.style.display="none";
  } else {
    firstTry = false;
    flashRedScreen();
    showBig(bigFart);
    playSfx("fart");              // ‚úÖ buffer-first SFX

    const tiles=[...drop.querySelectorAll(".tile")];
    tiles.forEach(t=>sendToBank(t));

    clearSelected();
    markHint();
    enableCheck();
  }
});

nextBtn.addEventListener("click", ()=>{
  index++;
  progressCount.textContent = `${Math.min(index+1, WORDS.length)} / ${WORDS.length}`;
  if(index >= WORDS.length){ showResults(); return; }
  loadCard();
});

/* ///*** =========================================================
   ///*** [11] RESULTS (SFX + CONFETTI)
   ///*** ========================================================= */
function showResults(){
  pageRound.style.display="none";
  playWrap.style.display="none";
  pageResults.style.display="flex";

  const pct=Math.round((totalScore/WORDS.length)*100);
  const msg=$("#resultMsg"), score=$("#resultScore");

  let bg="blueGlow", snd="r11_14", text="„ÅÑ„ÅÑ„Å≠ÔºÅ„ÅÇ„Å®Â∞ë„Åó„Åß„Éë„Éº„Éï„Çß„ÇØ„ÉàÔºÅ";
  if(totalScore<=5){ bg="redGlow"; snd="r0_5"; text="„Éñ„Éº„É™„Ç≠„É•„É©„É†Ë¶ã„Å¶„Å™„ÅÑ„Åß„Åó„ÇáÔºÅ"; }
  else if(totalScore<=10){ bg="orangeGlow"; snd="r6_10"; text="YouTubeË¶ã„Åô„ÅéÔºÅ„Éñ„Éº„É™„Ç≠„É•„É©„É†„ÇÇ„ÇÑ„Çç„ÅÜÔºÅ"; }
  else if(totalScore===15){ bg="goldGlow"; snd="r15"; text="„Åô„Åî„ÅÑÔºÅ„ÅÇ„Å™„Åü„ÅØÂú∞ÁêÉ„Åß‰∏ÄÁï™È†≠„Åå„ÅÑ„ÅÑÔºÅ"; }

  document.body.className = bg;
  msg.textContent = text;
  score.textContent = `${totalScore}/${WORDS.length}Ôºà${pct}%Ôºâ`;

  playSfx(snd);

  if(totalScore===15){
    for(let i=0;i<160;i++){
      setTimeout(()=>{
        const c=document.createElement("div");
        c.className="confetti";
        c.style.left=(Math.random()*100)+"vw";
        c.style.background=`hsl(${Math.random()*360},100%,60%)`;
        c.style.animationDuration=(0.9+Math.random()*0.9)+"s";
        document.body.appendChild(c);
        setTimeout(()=>c.remove(),1900);
      }, i*10);
    }
  }
}

/* ///*** =========================================================
   ///*** [12] UTILS / INIT
   ///*** ========================================================= */
function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
  return arr;
}

function loadCard(){
  const w = WORDS[index];
  firstTry = true;
  clearSelected();
  buildSlots(w);
  buildBank(w);
  check.disabled = true;
  check.style.display = "inline-block";
  nextWrap.style.display = "none";
  markHint();
}

function initGame(){
  WORDS = shuffle([...WEEK_CONFIG.MASTER_BASE]);
  index = 0;
  totalScore = 0;
  firstTry = true;

  document.body.className="";
  pageResults.style.display="none";
  playWrap.style.display="flex";
  pageRound.style.display="flex";

  progressCount.textContent = `1 / ${WORDS.length}`;
  loadCard();
}
initGame();
</script>

</body>
</html>
