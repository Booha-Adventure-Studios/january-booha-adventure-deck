<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Booha Make the Sentences â€“ January Week 1</title>
<meta name="theme-color" content="#0b1530" />
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=Noto+Sans+JP:wght@500;700&display=swap" rel="stylesheet" />

<style>
:root{
  --bg:#0b1530; --ink:#fff; --outline:#ffffff26; --radius:26px;
  --goldGlow:0 0 10px rgba(255,214,120,.55),0 0 22px rgba(255,214,120,.45);
  --slotGlow:0 0 0 4px rgba(255,214,120,.28), 0 0 18px rgba(255,214,120,.55), 0 12px 22px rgba(0,0,0,.35);
}

*{box-sizing:border-box;margin:0;padding:0;}
html,body{height:100%;}
body{
  background:var(--bg);
  color:var(--ink);
  font-family:system-ui,"Noto Sans JP",sans-serif;
  transition:background 1s;
  overflow-x:hidden;
  overflow-y:auto;                 /* âœ… scrollable */
  -webkit-overflow-scrolling:touch;
  padding-bottom:env(safe-area-inset-bottom);
}

/* Header */
header{text-align:center;padding:26px 12px 12px}
.h1{font-family:'Cinzel',serif;font-weight:900;font-size:clamp(34px,6.2vw,56px);}
.h2{font-family:'Cinzel',serif;font-weight:900;font-size:clamp(22px,4.5vw,36px);}
.h3{font-family:'Cinzel',serif;font-weight:900;font-size:clamp(16px,3.6vw,22px);}
.h4{font-weight:800;font-size:clamp(14px,3.4vw,20px);color:#cfe1ff;}

.wrap{max-width:1100px;margin:0 auto;padding:8px 16px 90px}
.panel{
  padding:20px;
  border:1px solid var(--outline);
  border-radius:var(--radius);
  background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.02));
  box-shadow:0 6px 24px rgba(0,0,0,.4);
  overflow:visible;
}

/* JP card */
.jpCard{
  border-radius:var(--radius);
  border:1px solid var(--outline);
  height:160px;
  display:flex;
  align-items:center;
  justify-content:center;
  margin-bottom:10px;
  background:repeating-linear-gradient(to bottom,#ff6ec7 0 28px,#5ee6ff 28px 56px,#ffd166 56px 84px,
  #8aff80 84px 112px,#c77dff 112px 140px,#fff680 140px 168px);
  background-size:100% 600px;
  animation:stripeSlide 18s linear infinite;
}
@keyframes stripeSlide{from{background-position-y:0}to{background-position-y:-600px}}
.jpText{
  font-weight:900;
  font-size:46px;
  color:#0b1530;
  text-shadow:0 1px 0 rgba(255,255,255,.6);
  text-align:center;
  padding:0 10px;
}
.hira{
  text-align:center;
  color:#d8e7ff;
  font-size:clamp(14px,3.5vw,18px);
  margin-bottom:18px
}

/* Areas */
.wordbank,.sentence{
  display:flex;
  flex-wrap:wrap;
  gap:12px;
  padding:12px;
  margin-bottom:14px;
}
.wordbank{justify-content:center;}
.sentence{
  justify-content:flex-start;
  align-items:center;
  min-height:120px;
  width:100%;
  border:1px dashed rgba(255,255,255,.25);
  border-radius:14px;
  padding:16px 12px;
  position:relative;
}

/* play button */
.playBtn{
  position:absolute;
  left:12px;
  bottom:-60px;
  width:54px;
  height:54px;
  border:none;
  border-radius:50%;
  background:linear-gradient(135deg,#c59b10 0%,#ffd95e 40%,#ffe898 60%,#b68006 100%);
  box-shadow:var(--goldGlow);
  color:#2a1b00;
  font-weight:900;
  font-size:26px;
  opacity:0;
  pointer-events:none;
  transition:opacity .3s, transform .15s;
  z-index:3;
}
.playBtn.show{opacity:1;pointer-events:auto;animation:twinkle 2.4s ease-in-out infinite;}
.playBtn:active{transform:scale(.96)}
.playBtn::before{content:"â–¶";display:block;text-align:center;line-height:54px;}
@keyframes twinkle{
  0%,100%{box-shadow:var(--goldGlow);}
  50%{box-shadow:0 0 14px rgba(255,235,94,1),0 0 26px rgba(255,235,94,1);}
}

/* chips */
.word{
  padding:14px 18px;
  font-weight:900;
  font-size:clamp(18px,4.2vw,26px);
  border:none;
  border-radius:20px;
  cursor:pointer;                  /* âœ… tap UI */
  user-select:none;
  -webkit-tap-highlight-color:transparent;
  touch-action:manipulation;
  box-shadow:0 0 0 4px var(--color),0 10px 22px rgba(0,0,0,.35);
  background:#fff;
  color:#06101f;
  text-shadow:0 1px 0 rgba(255,255,255,.65);
  transition:transform .12s, box-shadow .12s, filter .12s;
}
.word:active{transform:scale(.96)}
.word.selected{
  transform:translateY(-2px) scale(1.03);
  filter:saturate(1.15) brightness(1.06);
  box-shadow:
    0 0 0 4px rgba(125,211,252,.55),
    0 0 18px rgba(125,211,252,.55),
    0 12px 22px rgba(0,0,0,.35);
}

/* âœ… glow when in the sentence area */
.word.inSentence{
  box-shadow:var(--slotGlow);
  background:#fff7cf;
  color:#000;
}

/* buttons */
.btn{
  display:block;
  margin:16px auto 8px;
  border:none;
  border-radius:999px;
  padding:16px 36px;
  font-weight:900;
  font-size:clamp(18px,4vw,22px);
  cursor:pointer;
}
.btn.green{
  background:radial-gradient(circle at 30% 30%,#1ee99a,#15c473,#0ea85d);
  color:#00230f;
  box-shadow:0 0 0 5px rgba(34,197,94,.22),0 0 18px rgba(34,197,94,.8);
}
.btn.blue{
  background:radial-gradient(circle at 30% 30%,#66b3ff,#1e6eff);
  color:#00163a;
  box-shadow:0 0 0 5px rgba(102,179,255,.22),0 0 18px rgba(102,179,255,.8);
}
.btn:disabled{opacity:.45;cursor:not-allowed}

/* ONE big heart / ONE big fart */
.bigFx{
  position:fixed;
  left:50%; top:52%;
  transform:translate(-50%,-50%) scale(.6);
  opacity:0;
  pointer-events:none;
  z-index:9999;
  filter:drop-shadow(0 0 18px rgba(255,255,255,.22));
  will-change:transform,opacity;
}
.bigFx.show{animation:bigPop 900ms ease-out both;}
@keyframes bigPop{
  0%{opacity:0;transform:translate(-50%,-50%) scale(.6)}
  20%{opacity:1;transform:translate(-50%,-54%) scale(1.25)}
  100%{opacity:0;transform:translate(-50%,-64%) scale(1.55)}
}

/* results glow colors */
.redGlow{background:#5c0000;}
.orangeGlow{background:#773b00;}
.blueGlow{background:#001b5f;}
.goldGlow{background:#5a4600;}
.confetti{position:fixed;width:10px;height:14px;top:-10px;animation:fall linear forwards;z-index:9998}
@keyframes fall{
  0%{transform:translateY(-10px) rotate(0deg);}
  100%{transform:translateY(110vh) rotate(720deg);}
}

.end{
  position:fixed;
  inset:0;
  display:none;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  text-align:center;
  padding:24px 16px;
}
.end .msg{font-weight:900;font-size:clamp(26px,6vw,42px);}
.end .score{font-weight:900;font-size:clamp(22px,5vw,30px);margin:10px auto 20px;}
footer{text-align:center;color:#c9d4ec;font-family:'Cinzel',serif;font-weight:700;padding:40px 10px}

/* ğŸ”˜ Quit + â“ Help match other games */
.top-nav-btn{
  position:fixed; top:10px; left:10px; z-index:12001;
  border-radius:999px; padding:6px 14px;
  border:1px solid #ffffff66;
  background:rgba(15,23,42,.95);
  color:#fff; font-size:.78rem; font-weight:700; letter-spacing:.04em;
  cursor:pointer; display:flex; align-items:center; gap:4px;
  box-shadow:0 0 12px rgba(0,0,0,.6);
  backdrop-filter:blur(4px);
}
.top-nav-btn .jp{font-size:.72em;}
.top-nav-btn .en{font-size:.8em;}

.help-btn{
  position:fixed; top:10px; right:10px; z-index:12001;
  width:40px; height:40px; border-radius:999px;
  border:1px solid #ffffff88;
  background:radial-gradient(circle at 30% 30%,#7dd3fc,#1e3a8a 65%,#020617 100%);
  color:#fff; font-weight:900; font-size:20px;
  cursor:pointer; display:flex; align-items:center; justify-content:center;
  box-shadow:0 0 12px rgba(125,211,252,.9),0 0 28px rgba(59,130,246,.9),0 0 52px rgba(56,189,248,.9);
  backdrop-filter:blur(4px);
}
.help-btn:active{transform:scale(.95)}

/* Help modal */
.help-modal{position:fixed; inset:0; z-index:12000; display:none; align-items:center; justify-content:center;}
.help-modal.show{display:flex;}
.help-backdrop{position:absolute; inset:0; background:rgba(15,23,42,.8); backdrop-filter:blur(6px);}
.help-dialog{
  position:relative; z-index:1;
  max-width:720px; width:calc(100% - 32px); max-height:80vh;
  border-radius:20px; border:1px solid #ffffff33;
  background:radial-gradient(circle at top,#111827,#020617 55%);
  box-shadow:0 22px 70px rgba(0,0,0,.9);
  padding:18px 18px 20px;
  display:flex; flex-direction:column;
}
.help-dialog h2{font-family:'Cinzel',serif;font-size:1.2rem;text-align:center;margin-bottom:6px}
.help-sub{font-size:.85rem;text-align:center;color:#c7d2fe;margin-bottom:10px}
.help-body{
  margin-top:6px;
  padding-right:4px;
  font-size:.9rem;
  line-height:1.6;
  color:#e5e7f5;
  overflow-y:auto;
  -webkit-overflow-scrolling:touch;
}
.help-body h3{font-size:.9rem;margin:10px 0 4px;color:#bfdbfe}
.help-body ul{padding-left:1.1rem;margin:4px 0 10px}
.help-body li{margin-bottom:4px}
.help-close{position:absolute;top:8px;right:10px;border:none;background:transparent;color:#e5e7f5;font-size:22px;cursor:pointer}
@media (max-width:480px){
  .help-dialog{max-height:82vh;padding:16px 14px 18px;}
  .jpText{font-size:38px;}
}
</style>
</head>

<body>

<!-- ğŸ”˜ Quit + â“ Help -->
<button type="button" class="top-nav-btn" onclick="window.location.href='index.html'">
  <span class="jp">ã‚„ã‚ã‚‹</span>
  <span class="en">QUIT</span>
</button>
<button id="helpBtn" type="button" class="help-btn">?</button>

<header>
  <div class="h1">THE BOO-RICULUM</div>
  <div class="h2">MAKE THE SENTENCES</div>
  <div class="h3">January Week 1 â€“ Sentences</div>
  <div class="h4">ï¼‘æœˆç¬¬ï¼‘é€± â€“ æ–‡ã®ç·´ç¿’</div>
</header>

<div class="wrap" id="page-round">
  <div class="panel" id="panel">
    <div class="jpCard"><div id="jp" class="jpText"></div></div>
    <div id="hira" class="hira"></div>

    <div id="bank" class="wordbank"></div>

    <div style="position:relative;">
      <div id="sentence" class="sentence">
        <button id="playBtn" class="playBtn" title="Play"></button>
      </div>
    </div>

    <button id="checkBtn" class="btn green" disabled>Check</button>

    <div id="nextWrap" style="text-align:center;display:none">
      <button id="nextBtn" class="btn blue">Next</button>
    </div>

    <div id="progress" style="text-align:center;opacity:.9;font-weight:800;margin-top:6px">1 / 15</div>
  </div>
</div>

<!-- â“ Help popup (JP -> EN) -->
<div id="helpModal" class="help-modal" aria-hidden="true">
  <div class="help-backdrop" data-close-help></div>
  <div class="help-dialog">
    <button class="help-close" type="button" data-close-help>Ã—</button>
    <h2>éŠã³æ–¹ ï¼ HOW TO PLAY</h2>
    <div class="help-sub">Booha Make the Sentences</div>
    <div class="help-body">

      <h3>æ—¥æœ¬èªï¼ˆå…ˆã«ã“ã¡ã‚‰ï¼‰</h3>
      <ul>
        <li>ä¸Šã®<strong>æ—¥æœ¬èªã®æ–‡</strong>ï¼ˆï¼‹ã²ã‚‰ãŒãªãƒ’ãƒ³ãƒˆï¼‰ã‚’è¦‹ã¾ã™ã€‚</li>
        <li>ä¸‹ã®ç™½ã„å˜èªã‚¿ã‚¤ãƒ«ã‚’<strong>ã‚¿ãƒƒãƒ—</strong>ã—ã¦ã€ã‚°ãƒ¬ãƒ¼ã®ã‚¨ãƒªã‚¢ã«å…¥ã‚Œã¦æ–‡ã‚’ä½œã‚Šã¾ã™ã€‚</li>
        <li>ã‚°ãƒ¬ãƒ¼ã®ã‚¨ãƒªã‚¢ã®å˜èªã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨ã€å˜èªãƒãƒ³ã‚¯ã«æˆ»ã‚Šã¾ã™ã€‚</li>
        <li><strong>ä¸¦ã¹æ›¿ãˆ</strong>ï¼šã‚°ãƒ¬ãƒ¼ã®ä¸­ã®å˜èªã‚’ã‚¿ãƒƒãƒ—ã—ã¦é¸ã‚“ã§ã‹ã‚‰ã€åˆ¥ã®å˜èªã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨ã€ãã®å‰ã«å…¥ã‚Šã¾ã™ã€‚</li>
        <li>ã§ããŸã‚‰ <strong>Check</strong> ã‚’æŠ¼ã—ã¾ã™ã€‚</li>
        <li>æ­£è§£ï¼šâ¤ï¸ï¼ˆå¤§ï¼‰+ SageéŸ³å£° â†’ <strong>Next</strong></li>
        <li>ä¸æ­£è§£ï¼šğŸ’¨ï¼ˆå¤§ï¼‰â†’ ã‚¿ã‚¤ãƒ«ãŒæˆ»ã‚‹ã®ã§ã€ã‚‚ã†ä¸€åº¦ãªã‚‰ã¹ç›´ã—ã¾ã™ï¼ˆç‚¹æ•°ã¯å¢—ãˆã¾ã›ã‚“ï¼‰ã€‚</li>
        <li>é‡‘è‰²ã®<strong>â–¶</strong>ã§ Sage ãŒæ­£ã—ã„è‹±æ–‡ã‚’èª­ã‚“ã§ãã‚Œã¾ã™ã€‚</li>
      </ul>

      <h3>English</h3>
      <ul>
        <li>Look at the <strong>Japanese sentence</strong> (and the hiragana hint).</li>
        <li><strong>Tap</strong> the word tiles to move them into the gray sentence area.</li>
        <li>Tap a word in the sentence area to send it back to the bank.</li>
        <li><strong>Reorder</strong>: tap a word in the sentence area to select it, then tap another word to insert it before that word.</li>
        <li>Tap <strong>Check</strong> when you finish.</li>
        <li>Correct: ONE big â¤ï¸ + Sage voice â†’ <strong>Next</strong></li>
        <li>Wrong: ONE big ğŸ’¨ â†’ tiles return, try again (no point).</li>
        <li>Tap the gold <strong>â–¶</strong> to hear Sage read the correct sentence.</li>
      </ul>

    </div>
  </div>
</div>

<!-- Results page -->
<div id="page-results" class="end">
  <div class="msg" id="resultMsg"></div>
  <div class="score" id="resultScore"></div>
  <button class="btn blue" onclick="window.location.href='index.html'">Back to Main Menu</button>
  <footer style="opacity:.8">Bryanâ€™s English School</footer>
</div>

<!-- Big FX nodes -->
<div class="bigFx" id="bigHeart" aria-hidden="true" style="font-size:120px;">â¤ï¸</div>
<div class="bigFx" id="bigFart" aria-hidden="true" style="font-size:120px;">ğŸ’¨</div>

<footer>Bryanâ€™s English School</footer>

<!-- RESULTS AUDIO (non-sage) -->
<audio id="s_r05" src="assets/audio/result_0-5.mp3" preload="auto"></audio>
<audio id="s_r610" src="assets/audio/result_6-10.mp3" preload="auto"></audio>
<audio id="s_r1114" src="assets/audio/result_11-14.mp3" preload="auto"></audio>
<audio id="s_r15" src="assets/audio/result_15.mp3" preload="auto"></audio>

<!-- Sage player (single element, reliable) -->
<audio id="sageVoice" preload="auto"></audio>

<script>
/* =========================
   DATA
   ========================= */
const DATA=[
  {en:"I will study every day.",jp:"æ¯æ—¥å‹‰å¼·ã—ã¾ã™ã€‚",hira:"ã¾ã„ã«ã¡ ã¹ã‚“ãã‚‡ã† ã—ã¾ã™"},
  {en:"I will clean my desk today.",jp:"ä»Šæ—¥ã¯æœºã‚’ç‰‡ã¥ã‘ã¾ã™ã€‚",hira:"ãã‚‡ã† ã¯ ã¤ããˆ ã‚’ ã‹ãŸã¥ã‘ ã¾ã™"},
  {en:"I will speak more English.",jp:"ã‚‚ã£ã¨è‹±èªã‚’è©±ã—ã¾ã™ã€‚",hira:"ã‚‚ã£ã¨ ãˆã„ã” ã‚’ ã¯ãªã— ã¾ã™"},
  {en:"I will make a new friend.",jp:"æ–°ã—ã„å‹ã ã¡ã‚’ä½œã‚Šã¾ã™ã€‚",hira:"ã‚ãŸã‚‰ã—ã„ ã¨ã‚‚ã ã¡ ã‚’ ã¤ãã‚Š ã¾ã™"},
  {en:"I will not be late anymore.",jp:"ã‚‚ã†é…åˆ»ã—ã¾ã›ã‚“ã€‚",hira:"ã‚‚ã† ã¡ã“ã ã—ã¾ã›ã‚“"},
  {en:"I will listen carefully in class.",jp:"æˆæ¥­ã§ã—ã£ã‹ã‚Šèãã¾ã™ã€‚",hira:"ã˜ã‚…ãã‚‡ã† ã§ ã—ã£ã‹ã‚Š ãã ã¾ã™"},
  {en:"I will read more books.",jp:"ã‚‚ã£ã¨æœ¬ã‚’èª­ã¿ã¾ã™ã€‚",hira:"ã‚‚ã£ã¨ ã»ã‚“ ã‚’ ã‚ˆã¿ ã¾ã™"},
  {en:"I will write in my diary every week.",jp:"æ¯é€±æ—¥è¨˜ã‚’æ›¸ãã¾ã™ã€‚",hira:"ã¾ã„ã—ã‚…ã† ã«ã£ã ã‚’ ã‹ã ã¾ã™"},
  {en:"I will enjoy learning.",jp:"å­¦ã¶ã“ã¨ã‚’æ¥½ã—ã¿ã¾ã™ã€‚",hira:"ã¾ãªã¶ ã“ã¨ ã‚’ ãŸã®ã—ã¿ ã¾ã™"},
  {en:"I will try new things.",jp:"æ–°ã—ã„ã“ã¨ã«æŒ‘æˆ¦ã—ã¾ã™ã€‚",hira:"ã‚ãŸã‚‰ã—ã„ ã“ã¨ ã« ã¡ã‚‡ã†ã›ã‚“ ã—ã¾ã™"},
  {en:"I will help my friends.",jp:"å‹ã ã¡ã‚’åŠ©ã‘ã¾ã™ã€‚",hira:"ã¨ã‚‚ã ã¡ ã‚’ ãŸã™ã‘ ã¾ã™"},
  {en:"I will eat more vegetables.",jp:"ã‚‚ã£ã¨é‡èœã‚’é£Ÿã¹ã¾ã™ã€‚",hira:"ã‚‚ã£ã¨ ã‚„ã•ã„ ã‚’ ãŸã¹ ã¾ã™"},
  {en:"I will sleep early.",jp:"æ—©ãå¯ã¾ã™ã€‚",hira:"ã¯ã‚„ã ã­ ã¾ã™"},
  {en:"I will do my homework first.",jp:"ã¾ãšå®¿é¡Œã‚’ã—ã¾ã™ã€‚",hira:"ã¾ãš ã—ã‚…ãã ã„ ã‚’ ã— ã¾ã™"},
  {en:"I will be kind to everyone.",jp:"ã¿ã‚“ãªã«ã‚„ã•ã—ãã—ã¾ã™ã€‚",hira:"ã¿ã‚“ãª ã« ã‚„ã•ã—ã ã— ã¾ã™"}
];

// ğŸ”€ shuffle each load
shuffle(DATA);

/* =========================
   DOM
   ========================= */
const qs = s => document.querySelector(s);
const jp=qs('#jp'), hira=qs('#hira'), bank=qs('#bank'), sent=qs('#sentence');
const check=qs('#checkBtn'), nextWrap=qs('#nextWrap'), nextBtn=qs('#nextBtn');
const playBtn=qs('#playBtn'), progress=qs('#progress');

const bigHeart = qs('#bigHeart');
const bigFart  = qs('#bigFart');

const sageVoice = qs('#sageVoice');
let sagePrimed = false;

/* =========================
   STATE
   ========================= */
let i=0;
let score=0;
let wrongMode=false;
let selectedWord = null; // for reorder inside sentence

/* =========================
   SAGE (week1/audio/sentences/)
   filenames: v01_<slug>.mp3, v02_<slug>.mp3 ...
   ========================= */
function slugFromSentence(en){
  return (en||'')
    .toLowerCase()
    .trim()
    .replace(/[â€™â€˜Â´`]/g,"'")
    .replace(/[^a-z0-9]+/g,'_')
    .replace(/^_+|_+$/g,'');
}

function vNum(n){ return String(n).padStart(2,'0'); }

function sagePathForIndex(idx){
  const en = DATA[idx]?.en || '';
  const slug = slugFromSentence(en);
  // primary expected: v01_<slug>.mp3
  return `audio/sentences/v${vNum(idx+1)}_${slug}.mp3`;
}

async function primeSage(){
  if(sagePrimed) return;
  sagePrimed = true;
  try{
    sageVoice.muted = true;
    sageVoice.src = sagePathForIndex(0);
    const p = sageVoice.play();
    if(p && p.then) await p;
    sageVoice.pause();
    sageVoice.currentTime = 0;
    sageVoice.muted = false;
  }catch(e){
    sageVoice.muted = false;
  }
}

function playSageForCurrent(onEnd){
  const src = sagePathForIndex(i);
  let done=false;

  sageVoice.onended = () => {
    if(done) return;
    done=true;
    sageVoice.onended=null; sageVoice.onerror=null;
    if(onEnd) onEnd();
  };
  sageVoice.onerror = () => {
    if(done) return;
    done=true;
    sageVoice.onended=null; sageVoice.onerror=null;
    if(onEnd) onEnd();
  };

  try{
    sageVoice.src = src;
    sageVoice.currentTime = 0;
    const p = sageVoice.play();
    if(p && p.catch){
      p.catch(()=>{ if(!done){ done=true; if(onEnd) onEnd(); } });
    }
  }catch(_){
    if(onEnd) onEnd();
  }

  // safety
  setTimeout(()=>{ if(!done){ done=true; if(onEnd) onEnd(); } }, 9000);
}

/* =========================
   UI helpers
   ========================= */
function chipColor(n){
  const c=["#ff6ec7","#5ee6ff","#ffd166","#8aff80","#c77dff","#fff680","#ff9a8b","#9bffb7","#7cc6ff","#f7a6ff"];
  return c[n%c.length];
}
function updateProgress(){ progress.textContent=`${i+1} / ${DATA.length}`; }

function showBig(el){
  el.classList.remove('show');
  void el.offsetWidth;
  el.classList.add('show');
  setTimeout(()=>el.classList.remove('show'), 950);
}

function setSelected(w){
  clearSelected();
  selectedWord = w;
  if(selectedWord) selectedWord.classList.add('selected');
}
function clearSelected(){
  if(selectedWord) selectedWord.classList.remove('selected');
  selectedWord = null;
}

function refreshCheckState(){
  check.disabled = (bank.querySelectorAll('.word').length !== 0);
}

function moveToBank(word){
  word.classList.remove('inSentence','selected');
  bank.appendChild(word);
  refreshCheckState();
}
function moveToSentence(word, beforeEl=null){
  word.classList.add('inSentence');
  word.classList.remove('selected');
  if(beforeEl && beforeEl.parentElement === sent){
    sent.insertBefore(word, beforeEl);
  }else{
    sent.appendChild(word);
  }
  refreshCheckState();
}

/* =========================
   Build round
   ========================= */
function mount(){
  // reset
  bank.innerHTML='';
  // keep playBtn inside sentence container
  sent.innerHTML='';
  sent.appendChild(playBtn);

  playBtn.classList.remove('show');
  nextWrap.style.display='none';
  check.style.display='block';
  check.disabled=true;

  wrongMode=false;
  clearSelected();

  const item = DATA[i];
  jp.textContent=item.jp;
  hira.textContent=item.hira;

  const words = item.en.trim().split(/\s+/);
  shuffle(words).forEach((w,idx)=>{
    const b=document.createElement('button');
    b.type='button';
    b.textContent=w;
    b.className='word';
    b.style.setProperty('--color', chipColor(idx));

    // âœ… tap-to-move only
    b.addEventListener('click',(e)=>{
      e.stopPropagation();

      // always prime Sage on real user interaction
      primeSage();

      const parent = b.parentElement;
      if(parent === bank){
        moveToSentence(b);
        clearSelected();
      }else{
        // in sentence:
        // if another word is selected, insert selected before tapped word
        if(selectedWord && selectedWord !== b && selectedWord.parentElement === sent){
          const moving = selectedWord;
          clearSelected();
          moveToSentence(moving, b);
        }else{
          // toggle selection for reorder, OR send back if already selected
          if(b.classList.contains('selected')){
            moveToBank(b);
            clearSelected();
          }else{
            setSelected(b);
          }
        }
      }
    });

    bank.appendChild(b);
  });

  updateProgress();
  refreshCheckState();

  // Check handler
  check.onclick = () => {
    primeSage();
    check.disabled = true;
    checkLogic();
  };
}

/* sentence click = drop selection (nice UX on mobile) */
sent.addEventListener('click',(e)=>{
  if(e.target === sent || e.target === playBtn) clearSelected();
});
bank.addEventListener('click',(e)=>{
  if(e.target === bank) clearSelected();
});

/* =========================
   Logic
   ========================= */
function currentBuilt(){
  return [...sent.querySelectorAll('.word')].map(e=>e.textContent).join(' ').trim();
}
function currentCorrect(){
  return DATA[i].en.trim();
}

function checkLogic(){
  const correct = currentCorrect();
  const built = currentBuilt();

  if(built === correct){
    if(!wrongMode){
      score++;
      showBig(bigHeart);
    }else{
      showBig(bigHeart); // still reward the finish
    }

    // Sage reads it, THEN Next shows (consistent with other games)
    nextWrap.style.display='none';
    playBtn.classList.remove('show');

    setTimeout(()=>{
      playSageForCurrent(()=>{
        nextWrap.style.display='block';
      });
    }, 250);

  }else{
    // wrong = ONE big fart, return everything to bank, enable retry
    wrongMode = true;
    showBig(bigFart);

    // return all tiles
    [...sent.querySelectorAll('.word')].forEach(ch=>moveToBank(ch));
    clearSelected();

    // show gold play button for listening
    playBtn.classList.add('show');

    // keep Check available
    check.disabled = false;
  }
}

/* Next button */
nextBtn.onclick = () => {
  i++;
  if(i >= DATA.length) return finish();
  mount();
};

/* Gold play button = Sage */
playBtn.onclick = (e) => {
  e.stopPropagation();
  primeSage();
  playSageForCurrent();
};

/* =========================
   Results
   ========================= */
function finish(){
  qs('#page-round').style.display='none';
  showResults();
}

function showResults(){
  qs('#page-results').style.display='flex';

  const totalScore = score;
  const pct = Math.round((totalScore/15)*100);

  const msgEl = qs('#resultMsg');
  const scoreEl= qs('#resultScore');

  let bg="blueGlow", msg="ã„ã„ã­ï¼ã‚ã¨å°‘ã—ã§ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆï¼", snd=qs('#s_r1114');
  if(totalScore<=5){ bg="redGlow"; msg="ãƒ–ãƒ¼ãƒªã‚­ãƒ¥ãƒ©ãƒ è¦‹ã¦ãªã„ã§ã—ã‚‡ï¼"; snd=qs('#s_r05'); }
  else if(totalScore<=10){ bg="orangeGlow"; msg="YouTubeè¦‹ã™ãï¼ãƒ–ãƒ¼ãƒªã‚­ãƒ¥ãƒ©ãƒ ã‚‚ã‚„ã‚ã†ï¼"; snd=qs('#s_r610'); }
  else if(totalScore===15){ bg="goldGlow"; msg="ã™ã”ã„ï¼ã‚ãªãŸã¯åœ°çƒã§ä¸€ç•ªé ­ãŒã„ã„ï¼"; snd=qs('#s_r15'); }

  document.body.className = bg;
  msgEl.textContent = msg;
  scoreEl.textContent = `${totalScore}/15ï¼ˆ${pct}%ï¼‰`;

  try{ snd.currentTime=0; snd.play().catch(()=>{}); }catch(_){}

  if(totalScore===15){
    for(let k=0;k<160;k++){
      setTimeout(()=>{
        const c=document.createElement('div');
        c.className='confetti';
        c.style.left=(Math.random()*100)+'vw';
        c.style.background=`hsl(${Math.random()*360},100%,60%)`;
        c.style.animationDuration=(0.9+Math.random()*0.9)+'s';
        document.body.appendChild(c);
        setTimeout(()=>c.remove(),1900);
      }, k*10);
    }
  }
}

/* =========================
   Utils
   ========================= */
function shuffle(a){
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}

/* =========================
   Help modal
   ========================= */
const helpBtnEl = qs('#helpBtn');
const helpModal = qs('#helpModal');
if(helpBtnEl && helpModal){
  const closeEls = helpModal.querySelectorAll('[data-close-help]');
  const openHelp = ()=>{ helpModal.classList.add('show'); helpModal.setAttribute('aria-hidden','false'); };
  const closeHelp= ()=>{ helpModal.classList.remove('show'); helpModal.setAttribute('aria-hidden','true'); };
  helpBtnEl.addEventListener('click', openHelp);
  closeEls.forEach(el=>el.addEventListener('click', closeHelp));
  helpModal.addEventListener('click', e=>{ if(e.target===helpModal) closeHelp(); });
  document.addEventListener('keydown', e=>{ if(e.key==='Escape') closeHelp(); });
}

/* =========================
   Init
   ========================= */
mount();
</script>
</body>
</html>
