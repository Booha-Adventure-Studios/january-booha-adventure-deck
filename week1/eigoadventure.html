<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Booha Eigo Adventure â€“ January Week 1</title>
<meta name="theme-color" content="#0b1530" />
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=Noto+Sans+JP:wght@500;700;900&display=swap" rel="stylesheet" />

<style>
:root{
  --bg:#0b1530;--ink:#fff;--gold1:#fdd86d;--gold2:#ffb347;--outline:#ffffff26;--radius:26px;
  --goldGlow:0 0 8px #facc15,0 0 20px #fde68a;
  --purpleGlow:0 0 20px #c084fc,0 0 40px #c084fc;
  --talkGlow:0 0 14px rgba(250,204,21,.9),0 0 34px rgba(253,230,138,.65),0 0 54px rgba(192,132,252,.45);
}
*{box-sizing:border-box;margin:0;padding:0;}
body{
  background:var(--bg);
  color:var(--ink);
  font-family:'Noto Sans JP',sans-serif;
  min-height:100vh;
  display:flex;
  flex-direction:column;
  align-items:center;
  overflow-x:hidden;
}
header{text-align:center;padding:26px 12px 12px}
.h1{font-family:'Cinzel',serif;font-weight:900;font-size:clamp(34px,6.2vw,56px);} 
.h2{font-family:'Cinzel',serif;font-weight:900;font-size:clamp(18px,4.2vw,32px);} 
.h3{font-family:'Cinzel',serif;font-weight:900;font-size:clamp(16px,3.6vw,22px);} 

main{
  flex:1;
  display:flex;
  flex-direction:column;
  align-items:center;
  width:100%;
  max-width:700px;
  text-align:center;
  padding:0 1rem;
}

.sageWrapper{position:relative;width:100%;margin-top:1rem;}

/* Rainbow question box (tap to listen) */
#sageBox{
  width:100%;
  min-height:104px;
  border:1px solid var(--outline);
  border-radius:var(--radius);
  overflow:hidden;
  position:relative;
  margin-bottom:1rem;
  display:flex;
  align-items:center;
  justify-content:center;
  text-align:center;
  box-shadow:0 6px 24px rgba(0,0,0,.4);
  background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.02));
  cursor:pointer;
  user-select:none;
  -webkit-tap-highlight-color:transparent;
}
#sageBox::before{
  content:'';
  position:absolute;
  inset:0;
  z-index:0;
  animation:stripeSlide 18s linear infinite;
  background:repeating-linear-gradient(
    to bottom,
    #ff6ec7 0 28px,
    #5ee6ff 28px 56px,
    #ffd166 56px 84px,
    #8aff80 84px 112px,
    #c77dff 112px 140px,
    #fff680 140px 168px
  );
  background-size:100% 600px;
}
@keyframes stripeSlide{from{background-position-y:0}to{background-position-y:-600px}}

#sageBox.talking{
  box-shadow:var(--talkGlow);
  transform:translateY(-1px);
}
#sageBox.talking::after{
  content:"LISTENINGâ€¦";
  position:absolute;
  bottom:10px;
  right:14px;
  z-index:2;
  font-family:'Cinzel',serif;
  font-weight:900;
  letter-spacing:.06em;
  font-size:.75rem;
  color:#0b1530;
  opacity:.78;
  text-shadow:0 1px 0 rgba(255,255,255,.6);
}

#sageText{
  position:relative;
  z-index:1;
  font-weight:900;
  font-size:clamp(1.35rem,5vw,2rem);
  color:#0b1530;
  text-shadow:0 1px 0 rgba(255,255,255,.6);
  padding:0 1rem;
}
.word{opacity:0;margin:0 .35rem;transition:opacity .25s ease;}

.tapHint{
  margin-top:-10px;
  margin-bottom:10px;
  font-size:.95rem;
  color:#fdd86d;
  text-shadow:var(--goldGlow);
  line-height:1.25;
}
.tapHint small{display:block;color:#ffe27a;margin-top:3px;}

/* Student box */
.studentWrapper{position:relative;width:100%;}
#studentBox{
  width:100%;
  min-height:92px;
  border:1px solid var(--outline);
  border-radius:var(--radius);
  overflow:hidden;
  position:relative;
  margin-bottom:1rem;
  display:flex;
  align-items:center;
  justify-content:center;
  text-align:center;
  box-shadow:0 6px 24px rgba(0,0,0,.4);
  background:#fff;
  color:#000;
  transition:box-shadow .3s,background .3s,transform .15s;
  padding:0.8rem 1rem;
  font-weight:900;
  font-size:clamp(1.05rem,4.2vw,1.3rem);
  cursor:pointer;
  user-select:none;
  -webkit-tap-highlight-color:transparent;
}
#studentBox.listening{box-shadow:var(--purpleGlow);}
#studentBox.shake{animation:shake .3s;}
@keyframes shake{0%,100%{transform:translateX(0);}25%{transform:translateX(-5px);}75%{transform:translateX(5px);}}

/* Erase button (Android/Desktop only) */
.eraseBtn{
  position:absolute;
  right:-10px;
  top:50%;
  transform:translateY(-50%);
  border:none;
  border-radius:999px;
  padding:10px 14px;
  font-weight:900;
  cursor:pointer;
  background:linear-gradient(135deg,#93c5fd,#3b82f6);
  color:#00163a;
  box-shadow:0 0 14px rgba(59,130,246,.55);
  display:none;
}
.eraseBtn small{display:block;font-size:.75em;opacity:.85;}

.statusLine{
  margin-top:-6px;
  margin-bottom:10px;
  font-size:.95rem;
  color:#c7d2fe;
  text-shadow:0 0 10px rgba(59,130,246,.35);
  line-height:1.25;
}
.statusLine small{display:block;color:#93c5fd;margin-top:3px;}

/* answer options */
#options{width:100%;margin-top:0.5rem;}
#options .option{
  border:2px solid var(--outline);
  border-radius:var(--radius);
  padding:1rem;
  margin:0.5rem 0;
  width:100%;
  font-size:clamp(1.05rem,4vw,1.35rem);
  font-weight:800;
  background:#00000040;
  color:#fff;
  cursor:pointer;
  transition:opacity .2s,background .3s,border-color .3s,transform .1s;
}
#options .option:hover{transform:translateY(-1px);} 
#options .option.selected{
  background:#1d4ed8;
  border-color:#bfdbfe;
  box-shadow:0 0 12px rgba(59,130,246,.7);
}
#options.locked .option{cursor:not-allowed;opacity:.55;}

/* hint text */
#hintBox{
  margin-top:.8rem;
  font-size:1rem;
  color:#fdd86d;
  text-shadow:var(--goldGlow);
  line-height:1.4;
  min-height:2.2em;
}
#hintBox small{display:block;color:#ffe27a;margin-top:4px;}

.btnRow{display:flex;gap:1rem;justify-content:center;margin-top:1rem;flex-direction:column;align-items:center;}
.nextBtn{
  padding:.7rem 1.8rem;
  border-radius:var(--radius);
  color:#000;
  font-weight:900;
  font-family:'Cinzel',serif;
  font-size:1.1rem;
  border:none;
  cursor:pointer;
  display:none;
  background:linear-gradient(135deg,#f9a8d4,#ec4899);
  animation:pinkShimmer 2s infinite;
}
@keyframes pinkShimmer{0%,100%{box-shadow:0 0 10px #f9a8d4,0 0 20px #ec4899;}50%{box-shadow:0 0 20px #f472b6,0 0 40px #db2777;}}

#pointsContainer{display:flex;flex-direction:column;align-items:center;margin-top:0.8rem;}
#pointsCircle{width:90px;height:90px;border-radius:50%;background:linear-gradient(135deg,var(--gold1),var(--gold2));display:flex;align-items:center;justify-content:center;font-family:'Cinzel',serif;font-size:2rem;font-weight:900;box-shadow:var(--goldGlow);position:relative;overflow:hidden;text-shadow:0 0 10px #fff,0 0 20px #fff;z-index:1;}
#pointsCircle span{position:relative;z-index:2;color:#000;}
#pointsCircle::after{content:'';position:absolute;width:140%;height:140%;background:radial-gradient(circle at 50% 50%,rgba(255,255,255,0.6) 0%,rgba(255,255,255,0) 70%);animation:pulse 2.5s infinite ease-in-out;z-index:0;}
@keyframes pulse{0%,100%{transform:scale(1);}50%{transform:scale(1.3);opacity:0.6;}}
#scoreLabel{margin-top:8px;font-family:'Cinzel',serif;font-size:1rem;color:#fdd86d;text-shadow:var(--goldGlow);animation:goldShimmer 2s infinite;}
@keyframes goldShimmer{0%,100%{text-shadow:0 0 8px #facc15,0 0 20px #fde68a;}50%{text-shadow:0 0 14px #ffef9f,0 0 30px #fde68a;}}
#counter{margin-top:4px;font-family:'Cinzel',serif;color:#fff;font-size:1rem;text-shadow:0 0 6px rgba(255,255,255,.4);}
footer{text-align:center;color:#fff;padding:16px 0 22px;font-family:'Cinzel',serif;font-weight:900;font-size:clamp(14px,2.8vw,20px);}

@media (max-width:520px){#sageText{font-weight:900;font-size:1.22rem;}}

/* ğŸ”˜ Standard Booha QUIT button (small version) */
.top-nav-btn{position:fixed;top:10px;left:10px;z-index:12001;border-radius:999px;padding:6px 14px;border:1px solid #ffffff66;background:rgba(15,23,42,.95);color:#fff;font-size:.78rem;font-weight:700;letter-spacing:.04em;cursor:pointer;display:flex;align-items:center;gap:4px;box-shadow:0 0 12px rgba(0,0,0,.6);backdrop-filter:blur(4px);} 
.top-nav-btn .jp{font-size:.72em;} .top-nav-btn .en{font-size:.8em;}

/* â“ Glowing help button */
.help-btn{position:fixed;top:10px;right:10px;z-index:12001;width:40px;height:40px;border-radius:999px;border:1px solid #ffffff88;background:radial-gradient(circle at 30% 30%,#7dd3fc,#1e3a8a 65%,#020617 100%);color:#fff;font-weight:900;font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 0 12px rgba(125,211,252,.9),0 0 28px rgba(59,130,246,.9),0 0 52px rgba(56,189,248,.9);backdrop-filter:blur(4px);} 

/* ğŸªŸ Help modal */
.help-modal{position:fixed;inset:0;z-index:12000;display:none;align-items:center;justify-content:center;} .help-modal.show{display:flex;} 
.help-backdrop{position:absolute;inset:0;background:rgba(15,23,42,.8);backdrop-filter:blur(6px);} 
.help-dialog{position:relative;z-index:1;max-width:720px;width:calc(100% - 32px);max-height:80vh;border-radius:20px;border:1px solid #ffffff33;background:radial-gradient(circle at top,#111827,#020617 55%);box-shadow:0 22px 70px rgba(0,0,0,.9);padding:18px 18px 20px;display:flex;flex-direction:column;} 
.help-dialog h2{font-family:'Cinzel',serif;font-size:1.2rem;text-align:center;margin-bottom:6px;} 
.help-sub{font-size:.85rem;text-align:center;color:#c7d2fe;margin-bottom:10px;} 
.help-body{margin-top:6px;padding-right:4px;font-size:.9rem;line-height:1.6;color:#e5e7f5;overflow-y:auto;} 
.help-body h3{font-size:.9rem;margin:10px 0 4px;color:#bfdbfe;} 
.help-body ul{padding-left:1.1rem;margin:4px 0 10px;} 
.help-body li{margin-bottom:4px;} 
.help-close{position:absolute;top:8px;right:10px;border:none;background:transparent;color:#e5e7f5;font-size:22px;cursor:pointer;} 

/* âœ… Results overlay */
.resultsOverlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:14000;text-align:center;padding:20px;} 
.resultsInner{width:min(720px, calc(100% - 28px));border-radius:26px;border:1px solid #ffffff33;background:radial-gradient(circle at top,#111827,#020617 58%);box-shadow:0 26px 80px rgba(0,0,0,.9);padding:22px 18px 18px;color:#fff;} 
.resultsTitle{font-family:'Cinzel',serif;font-weight:900;font-size:clamp(26px,6vw,42px);margin-bottom:10px;} 
.resultsScore{font-weight:900;font-size:clamp(24px,5.8vw,44px);margin:10px 0 14px;} 
.resultsMsg{font-weight:900;font-size:clamp(18px,4vw,26px);margin:8px 0 16px;} 
.resultsBtns{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;} 
.rb{border:none;border-radius:999px;padding:12px 18px;font-weight:900;cursor:pointer;} 
.rb.green{background:linear-gradient(135deg,#4ade80,#22c55e);color:#022c22;} 
.rb.blue{background:linear-gradient(135deg,#93c5fd,#3b82f6);color:#00163a;} 
</style>
</head>

<body>
<button type="button" class="top-nav-btn" onclick="window.location.href='index.html'">
  <span class="jp">ã‚„ã‚ã‚‹</span>
  <span class="en">QUIT</span>
</button>
<button id="helpBtn" type="button" class="help-btn">?</button>

<header>
  <div class="h1">THE BOO-RICULUM</div>
  <div class="h2">Eigo Adventure â€“ January Week 1</div>
  <div class="h3">ï¼‘æœˆç¬¬ï¼‘é€± â€“ è‹±èªã‚¢ãƒ‰ãƒ™ãƒ³ãƒãƒ£ãƒ¼</div>
</header>

<main>
  <div class="sageWrapper">
    <div id="sageBox" role="button" aria-label="Tap to listen">
      <div id="sageText"></div>
    </div>
    <div class="tapHint">ã“ã“ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ Sage ã‚’èã“ã†ï¼<small>Tap the rainbow box to listen to Sage.</small></div>
  </div>

  <div class="studentWrapper">
    <div id="studentBox"></div>
    <button id="eraseBtn" class="eraseBtn" type="button">ã‘ã™<small>Erase</small></button>
  </div>

  <div id="statusLine" class="statusLine" style="display:none"></div>

  <div id="options"></div>
  <div id="hintBox"></div>

  <div class="btnRow">
    <div id="pointsContainer">
      <div id="pointsCircle"><span id="pointsValue">0</span></div>
      <div id="scoreLabel">SCORE</div>
      <div id="counter">1 / 15</div>
    </div>
    <button class="nextBtn" id="nextBtn">Next â–¶</button>
  </div>
</main>

<footer>Bryanâ€™s English School</footer>

<!-- â“ Help popup -->
<div id="helpModal" class="help-modal" aria-hidden="true">
  <div class="help-backdrop" data-close-help></div>
  <div class="help-dialog">
    <button class="help-close" type="button" data-close-help>Ã—</button>
    <h2>éŠã³æ–¹ ï¼ How to Play</h2>
    <div class="help-sub">Booha Eigo Adventure Game</div>
    <div class="help-body">
      <h3>æ—¥æœ¬èª</h3>
      <ul>
        <li><strong>è™¹ã®è³ªå•ãƒœãƒƒã‚¯ã‚¹</strong>ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã€Sage ã®ã—ã¤ã‚‚ã‚“ï¼ˆè‹±èªï¼‰ã‚’èãã¾ã™ã€‚ï¼ˆè©±ã—ã¦ã„ã‚‹é–“ã¯å…‰ã‚Šã¾ã™ï¼‰</li>
        <li>ä¸‹ã®ï¼”ã¤ã‹ã‚‰ç­”ãˆã‚’é¸ã³ã¾ã™ã€‚</li>
        <li><strong>ãƒ‘ã‚½ã‚³ãƒ³ãƒ»Androidï¼š</strong>ç™½ã„ãƒœãƒƒã‚¯ã‚¹ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã€ãƒã‚¤ã‚¯ã‚’<strong>ON / OFF</strong>ã—ã¾ã™ã€‚ONã®ã¨ãã¯ç´«ã«å…‰ã‚Šã¾ã™ã€‚</li>
        <li>å£°ã§ç­”ãˆã‚‹ã¨ã€ç™½ã„ãƒœãƒƒã‚¯ã‚¹ã«è‹±èªãŒå‡ºã¾ã™ã€‚ã¾ã¡ãŒãˆãŸã‚‰ã€æ–‡å­—ã¯<strong>æ¶ˆãˆã‚‹ã¾ã§æ®‹ã‚Šã¾ã™</strong>ã€‚<strong>ã€Œã‘ã™ã€</strong>ã§æ¶ˆã—ã¦ã€ã‚‚ã†ä¸€å›ï¼</li>
        <li><strong>iPad / iPhoneï¼š</strong>ç­”ãˆã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨ç™½ã„ãƒœãƒƒã‚¯ã‚¹ã«å…¥ã‚Šã€<strong>è‡ªå‹•ã§ãƒã‚§ãƒƒã‚¯</strong>ã•ã‚Œã¾ã™ã€‚</li>
        <li>æ­£è§£ï¼š<strong>ding</strong>ï¼‹ç´™å¹é›ªï¼ä¸æ­£è§£ï¼š<strong>fart</strong>ï¼‹ãƒ–ãƒ«ãƒ–ãƒ«</li>
        <li>ãœã‚“ã¶ã§<strong>15å•</strong>ã€‚æœ€å¾Œã«çµæœç”»é¢ã¨éŸ³ãŒå‡ºã¾ã™ã€‚</li>
      </ul>

      <h3>English</h3>
      <ul>
        <li>Tap the <strong>rainbow question box</strong> to hear Sage. (It glows while speaking.)</li>
        <li>Choose the correct sentence from the 4 options.</li>
        <li><strong>Computers & Android:</strong> tap the white box to turn the mic <strong>ON / OFF</strong>. It glows purple when ON.</li>
        <li>Speak your answer and the white box shows what the device heard. If youâ€™re wrong, the text stays until you erase it. Tap <strong>Erase</strong> to clear and try again.</li>
        <li><strong>iPad / iPhone:</strong> tap an option to move it into the box and it <strong>auto-checks</strong>.</li>
        <li>Correct: <strong>ding</strong> + confetti. Wrong: <strong>fart</strong> + shake.</li>
        <li>There are <strong>15 questions</strong>. At the end, you get a results screen + sound.</li>
      </ul>
    </div>
  </div>
</div>

<!-- âœ… Results overlay -->
<div id="resultsOverlay" class="resultsOverlay" aria-hidden="true">
  <div class="resultsInner">
    <div class="resultsTitle">RESULT</div>
    <div id="resultsScore" class="resultsScore">0/15ï¼ˆ0%ï¼‰</div>
    <div id="resultsMsg" class="resultsMsg">ãŠã¤ã‹ã‚Œã•ã¾ï¼</div>
    <div class="resultsBtns">
      <button id="restartBtn" class="rb green">ã‚‚ã†ä¸€åº¦ / Restart</button>
      <button class="rb blue" onclick="window.location.href='index.html'">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ / Menu</button>
    </div>
  </div>
</div>

<!-- âœ… Results audio (local) -->
<audio id="r05"  src="assets/audio/result_0-5.mp3"  preload="auto"></audio>
<audio id="r610" src="assets/audio/result_6-10.mp3" preload="auto"></audio>
<audio id="r1114" src="assets/audio/result_11-14.mp3" preload="auto"></audio>
<audio id="r15"  src="assets/audio/result_15.mp3"  preload="auto"></audio>

<script>
/* =========================================
   Booha Eigo Adventure â€“ Dec 13 retooling
   Fixes per your note:
   - Sage should actually talk: tries q##_<slug>.mp3 then legacy filename
   - Remove rainbow emoji (done)
   - Android/Desktop mic is NOT always listening: tap white box toggles ON/OFF
   - Purple glow when listening
   ========================================= */

const SFX = { ding: "assets/audio/ding.mp3", fart: "assets/audio/fart.mp3" };
const RES = {
  r05:  document.getElementById('r05'),
  r610: document.getElementById('r610'),
  r1114:document.getElementById('r1114'),
  r15:  document.getElementById('r15')
};

const isIOS = /iP(hone|od|ad)/.test(navigator.userAgent) ||
  (navigator.platform === "MacIntel" && navigator.maxTouchPoints > 1);

const $=s=>document.querySelector(s);
const sageBox=$('#sageBox');
const sageText=$('#sageText');
const studentBox=$('#studentBox');
const eraseBtn=$('#eraseBtn');
const statusLine=$('#statusLine');
const optionsBox=$('#options');
const hintBox=$('#hintBox');
const nextBtn=$('#nextBtn');
const pointsValue=$('#pointsValue');
const counter=$('#counter');

const helpBtn=$('#helpBtn');
const helpModal=$('#helpModal');

const resultsOverlay = document.getElementById('resultsOverlay');
const resultsScore = document.getElementById('resultsScore');
const resultsMsg = document.getElementById('resultsMsg');
const restartBtn = document.getElementById('restartBtn');

let questions=[
  {q:"What do you eat for breakfast?", a:0, legacy:"whatdoyoueatforbreakfast.mp3", answers:[
    "I eat rice and miso soup for breakfast.","I eat curry for breakfast.","I eat toothpaste for breakfast.","I eat pencils and notebooks for breakfast."]},
  {q:"What do you do after school?", a:0, legacy:"whatdoyoudoafterschool.mp3", answers:[
    "I do my homework after school.","I climb trees after school.","I build a spaceship after school.","I wrestle with ghosts after school."]},
  {q:"What time do you wake up?", a:0, legacy:"whattimedoyouwakeup.mp3", answers:[
    "I wake up at 7 o'clock.","I sleep until midnight.","I wake up on the moon.","I wake up when my cat starts singing."]},
  {q:"How do you go to school?", a:0, legacy:"howdoyougotoschool.mp3", answers:[
    "I go to school by bus.","I go to school by rocket.","I go to school on a flying carpet.","I go to school by penguin."]},
  {q:"What do you drink in the morning?", a:0, legacy:"whatdoyoudrinkinthemorning.mp3", answers:[
    "I drink milk in the morning.","I drink tomato soup in the morning.","I drink hot glue in the morning.","I drink air in the morning."]},
  {q:"What do you do before bed?", a:0, legacy:"whatdoyoudobeforebed.mp3", answers:[
    "I brush my teeth before bed.","I brush my shoes before bed.","I play soccer before bed.","I eat spaghetti before bed."]},
  {q:"What do you do on weekends?", a:0, legacy:"whatdoyoudoonweekends.mp3", answers:[
    "I play games on weekends.","I study math all night.","I climb Mount Fuji every weekend.","I wash my dogâ€™s homework."]},
  {q:"What time do you go to bed?", a:0, legacy:"whattimedoyougotobed.mp3", answers:[
    "I go to bed at 9 o'clock.","I go to bed in the morning.","I go to bed on the bus.","I go to bed in the refrigerator."]},
  {q:"What do you have for lunch?", a:0, legacy:"whatdoyouhaveforlunch.mp3", answers:[
    "I have curry and rice for lunch.","I have cake and cookies for lunch.","I have ice cubes for lunch.","I have crayons for lunch."]},
  {q:"What do you do in the evening?", a:0, legacy:"whatdoyoudointheevening.mp3", answers:[
    "I watch TV in the evening.","I swim in my bathtub in the evening.","I chase ghosts in the evening.","I do jumping jacks on the roof."]},
  {q:"What do you do on Monday?", a:0, legacy:"whatdoyoudoonmonday.mp3", answers:[
    "I study English on Monday.","I dance with my teacher on Monday.","I fly to the moon on Monday.","I eat noodles on the roof on Monday."]},
  {q:"What do you do after dinner?", a:0, legacy:"whatdoyoudoafterdinner.mp3", answers:[
    "I take a bath after dinner.","I do my taxes after dinner.","I chase my cat after dinner.","I eat more dinner after dinner."]},
  {q:"What time do you eat dinner?", a:0, legacy:"whattimedoyoueatdinner.mp3", answers:[
    "I eat dinner at 7 o'clock.","I eat dinner at midnight.","I eat dinner at school.","I eat dinner while running."]},
  {q:"What do you do on Sunday?", a:0, legacy:"whatdoyoudoonsunday.mp3", answers:[
    "I go shopping on Sunday.","I do push-ups in the park on Sunday.","I scare my brother on Sunday.","I ride a unicorn on Sunday."]},
  {q:"Who do you eat dinner with?", a:0, legacy:"whodoyoueatdinnerwith.mp3", answers:[
    "I eat dinner with my family.","I eat dinner with my pet rock.","I eat dinner with my teacherâ€™s ghost.","I eat dinner with my shadow."]}
];

function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}
questions=shuffle(questions.map(q=>{
  const correct=q.answers[q.a];
  const mixed=shuffle([...q.answers]);
  return {...q,answers:mixed,correct};
}));

let current=0, points=0;
let gotCorrect=false, firstAttempt=true;
let recog=null;
let micEnabled=false;
let iosSelectedIndex=null, iosFirstAttempt=true;

function playSfx(path){const a=new Audio(path);a.preload='auto';a.play().catch(()=>{});} 

function tryPlay(path){
  return new Promise(resolve=>{
    const a=new Audio(path);
    let started=false;
    a.onplaying=()=>{started=true;};
    a.onended=()=>resolve(started);
    a.onerror=()=>resolve(false);
    a.play().then(()=>{started=true;}).catch(()=>resolve(false));
    setTimeout(()=>resolve(started), 9000);
  });
}

function qAudioFilename(qText, index1){
  const n = String(index1).padStart(2,'0');
  const slug = qText
    .toLowerCase()
    .replace(/[â€™â€˜Â´`]/g,"'")
    .replace(/\s+/g,' ')
    .trim()
    .replace(/\?/g,'')
    .replace(/[^a-z0-9\s]/g,'')
    .replace(/\s+/g,'_');
  return `q${n}_${slug}.mp3`;
}

function currentQuestion(){return questions[current];}

async function playQuestionAudioForCurrent(){
  const q = currentQuestion();
  const fileNew = qAudioFilename(q.q, q.index1);
  const pathNew = 'audio/questions/' + fileNew;
  const pathLegacy = q.legacy ? ('audio/questions/' + q.legacy) : null;

  sageBox.classList.add('talking');
  sageBox.setAttribute('aria-disabled','true');
  try{
    let ok = await tryPlay(pathNew);
    if(!ok && pathLegacy) ok = await tryPlay(pathLegacy);
    if(!ok){
      setHint('ï¼ˆéŸ³å£°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼‰','(Audio file not found)');
      console.warn('Question audio not found:', pathNew, pathLegacy);
    }
  } finally {
    sageBox.classList.remove('talking');
    sageBox.removeAttribute('aria-disabled');
  }
}

function updateUI(){pointsValue.textContent=points;counter.textContent=(current+1)+' / '+questions.length;}
function animateWords(t){sageText.innerHTML='';t.split(' ').forEach((w,i)=>{const s=document.createElement('span');s.className='word';s.textContent=w;sageText.appendChild(s);setTimeout(()=>s.style.opacity=1,180*i);});}
function pulsePoints(){const circle=document.getElementById('pointsCircle');circle.style.transform='scale(1.3)';setTimeout(()=>circle.style.transform='scale(1)',300);} 
function confetti(n=80){for(let i=0;i<n;i++){const c=document.createElement('div');c.style.cssText=`position:fixed;width:10px;height:10px;left:${Math.random()*100}%;top:-10px;background:hsl(${Math.random()*360},100%,70%);opacity:.9;pointer-events:none;z-index:9999;`;document.body.appendChild(c);const d=900+Math.random()*1200;c.animate([{transform:'translateY(0)'},{transform:'translateY(100vh) rotate(720deg)'}],{duration:d,easing:'ease-out'});setTimeout(()=>c.remove(),d);}} 

function normalize(s){
  return (s||"")
    .toLowerCase()
    .replace(/[â€™â€˜Â´`]/g,"'")
    .replace(/'s\b/g,"s")
    .replace(/'/g,"")
    .replace(/[^a-z0-9\s]/g,' ')
    .replace(/\s+/g,' ')
    .trim();
}
function isTimeLike(str){return /\b\d+\b/.test(str) && (str.includes("oclock") || /\bclock\b/.test(str));}
function timeMatch(ns,na){let sa=ns.split(' ');let aa=na.split(' ');if(aa.includes('oclock') && sa.includes('00') && !sa.includes('oclock')){sa = sa.map(w=>w==='00'?'oclock':w);} else if(sa.includes('oclock') && aa.includes('00') && !aa.includes('oclock')){aa = aa.map(w=>w==='00'?'oclock':w);}const overlap=aa.filter(w=>sa.includes(w)).length;const extra=sa.filter(w=>!aa.includes(w));return overlap/aa.length>=0.8 && extra.length<=2;}
function strictMatch(s,a){const ns=normalize(s), na=normalize(a);if(!ns||!na) return false;if(isTimeLike(na)) return timeMatch(ns,na);const sa=ns.split(' '), aa=na.split(' ');const overlap=aa.filter(w=>sa.includes(w)).length;const extra=sa.filter(w=>!aa.includes(w));return overlap/aa.length>=0.9 && extra.length<=2;}

function setHint(jp,en){hintBox.innerHTML=`${jp}<small>${en}</small>`;}

function setModeUI(){
  if(isIOS){
    statusLine.style.display='none';
    eraseBtn.style.display='none';
    optionsBox.classList.remove('locked');
    studentBox.classList.remove('listening');
  } else {
    statusLine.style.display='block';
    eraseBtn.style.display='inline-block';
    optionsBox.classList.add('locked');
    statusLine.innerHTML = `ç™½ã„ãƒœãƒƒã‚¯ã‚¹ã‚’ã‚¿ãƒƒãƒ—ï¼šãƒã‚¤ã‚¯ ON / OFF<small>Tap the white box: Mic ON / OFF</small>`;
  }
}

function renderAnswers(){
  optionsBox.innerHTML='';
  const q=currentQuestion();
  q.answers.forEach((a,i)=>{
    const d=document.createElement('div');
    d.className='option';
    d.dataset.index=i;
    d.textContent=a;
    d.addEventListener('click',()=>{
      if(!isIOS){
        setHint('ãƒ‘ã‚½ã‚³ãƒ³ãƒ»Android ã¯ã€Œå£°ã§ç­”ãˆã‚‹ã€ãƒ¢ãƒ¼ãƒ‰ã ã‚ˆã€‚','On computers/Android, answer by speaking.');
        return;
      }
      document.querySelectorAll('.option').forEach(o=>o.classList.remove('selected'));
      d.classList.add('selected');
      iosSelectedIndex=i;
      studentBox.textContent=a;
      checkIOSAnswer();
    });
    optionsBox.appendChild(d);
  });
}

async function wrongAndroidDesktop(){
  studentBox.classList.add('shake');
  studentBox.style.background='#fee2e2';
  playSfx(SFX.fart);
  setHint('ã¡ãŒã†ï¼è¦‹ã¦ã‹ã‚‰ã€Œã‘ã™ã€ï¼','Wrong! Look at it, then tap Erase.');
  await new Promise(r=>setTimeout(r, 320));
  studentBox.classList.remove('shake');
}
async function wrongIOS(){
  playSfx(SFX.fart);
  studentBox.classList.add('shake');
  studentBox.style.background='#fee2e2';
  setHint('ã¡ãŒã†ï¼ã‚‚ã†ä¸€å›ï¼','Wrong! Try again.');
  await new Promise(r=>setTimeout(r, 1100));
  studentBox.classList.remove('shake');
  studentBox.style.background='#fff';
  studentBox.textContent='';
  iosSelectedIndex=null;
  document.querySelectorAll('.option').forEach(o=>o.classList.remove('selected'));
}

function correctCommon(){
  gotCorrect=true;
  playSfx(SFX.ding);
  confetti(70);
  points += firstAttempt ? 1 : 0;
  pulsePoints();
  updateUI();
  setHint('æ­£è§£ï¼ã¤ãã¸é€²ã‚‚ã†ã€‚','Correct! Tap Next.');
  nextBtn.style.display='inline-block';
  if(!isIOS) stopMic();
}

async function checkIOSAnswer(){
  if(gotCorrect) return;
  const q=currentQuestion();
  if(iosSelectedIndex===null) return;
  const answer=q.answers[iosSelectedIndex];
  if(answer===q.correct){
    if(!iosFirstAttempt) firstAttempt=false;
    correctCommon();
  } else {
    iosFirstAttempt=false;
    firstAttempt=false;
    await wrongIOS();
  }
}

function ensureRecog(){
  const R=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!R){
    statusLine.style.display='block';
    statusLine.innerHTML = `âš ï¸ éŸ³å£°èªè­˜ãŒä½¿ãˆã¾ã›ã‚“<small>Speech recognition is not supported.</small>`;
    return;
  }
  if(recog) return;

  recog=new R();
  recog.lang='en-US';
  recog.interimResults=true;

  recog.onend=()=>{}; // no auto restart
  recog.onerror=()=>{
    statusLine.style.display='block';
    statusLine.innerHTML = `âš ï¸ ãƒã‚¤ã‚¯ã‚’è¨±å¯ã—ã¦ã­<small>Please allow microphone access.</small>`;
    setMicUI(false);
  };
  recog.onresult=e=>{
    if(!micEnabled || gotCorrect) return;
    let t='';
    for(const r of e.results){
      t += r[0].transcript + ' ';
      if(r.isFinal){
        const final = t.trim();
        studentBox.textContent=final;
        checkSpeech(final);
      }
    }
    const interim=t.trim();
    if(interim && !gotCorrect) studentBox.textContent=interim;
  };
}

function startMic(){
  if(isIOS) return;
  if(!recog) ensureRecog();
  if(!recog) return;
  try{recog.start();}catch{}
}
function stopMic(){ if(recog){ try{recog.stop();}catch{} } }

function setMicUI(on){
  micEnabled = on;
  if(on){
    studentBox.classList.add('listening');
    statusLine.innerHTML = `ğŸ¤ ONï¼ˆè©±ã—ã¦ã­ï¼‰<small>Mic ON (speak now)</small>`;
  } else {
    studentBox.classList.remove('listening');
    statusLine.innerHTML = `ğŸ¤ OFFï¼ˆã‚¿ãƒƒãƒ—ã§ONï¼‰<small>Mic OFF (tap to turn ON)</small>`;
  }
}

async function checkSpeech(spoken){
  if(isIOS || gotCorrect || !micEnabled) return;
  const q=currentQuestion();
  const matchIndex=q.answers.findIndex(ans=>strictMatch(spoken,ans));
  if(matchIndex===-1){
    firstAttempt=false;
    await wrongAndroidDesktop();
    return;
  }
  const isCorrect = strictMatch(spoken, q.correct);
  if(isCorrect) correctCommon();
  else { firstAttempt=false; await wrongAndroidDesktop(); }
}

function loadQuestion(){
  gotCorrect=false;
  firstAttempt=true;
  iosSelectedIndex=null;
  iosFirstAttempt=true;

  hintBox.textContent='';
  studentBox.textContent='';
  studentBox.style.background='#fff';
  nextBtn.style.display='none';

  const q=currentQuestion();
  animateWords(q.q);
  renderAnswers();
  updateUI();
  setModeUI();

  if(!isIOS){
    ensureRecog();
    setMicUI(false);
    setHint('ç™½ã„ãƒœãƒƒã‚¯ã‚¹ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã€ãƒã‚¤ã‚¯ã‚’ONã«ã—ã¦ã­ã€‚','Tap the white box to turn the mic ON.');
  } else {
    setHint('iPad / iPhoneï¼šç­”ãˆã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨è‡ªå‹•ãƒã‚§ãƒƒã‚¯ï¼','iPad/iPhone: Tap an answer to auto-check.');
  }
}

// Sage box tap
let audioLock=false;
sageBox.addEventListener('click', async ()=>{
  if(audioLock) return;
  audioLock=true;
  try{ await playQuestionAudioForCurrent(); }
  finally{ audioLock=false; }
});

// Mic toggle on student box (Android/Desktop)
studentBox.addEventListener('click', ()=>{
  if(isIOS) return;
  if(!recog) ensureRecog();
  if(!recog) return;
  if(micEnabled){
    setMicUI(false);
    stopMic();
    setHint('ãƒã‚¤ã‚¯OFFã€‚ã‚‚ã†ä¸€å›ã‚¿ãƒƒãƒ—ã§ONã€‚','Mic OFF. Tap again to turn ON.');
  } else {
    setMicUI(true);
    startMic();
    setHint('ãƒã‚¤ã‚¯ONã€‚è‹±èªã§è¨€ã£ã¦ã­ã€‚','Mic ON. Speak your answer.');
  }
});

// Erase
function clearAnswer(){
  studentBox.textContent='';
  studentBox.style.background='#fff';
  if(!isIOS) setHint('æ¶ˆã—ãŸã‚ˆã€‚ã‚‚ã†ä¸€å›è¨€ã£ã¦ã­ã€‚','Cleared. Say it again.');
}
eraseBtn.addEventListener('click', (e)=>{ e.stopPropagation(); clearAnswer(); });

nextBtn.onclick=()=>{
  current++;
  if(current>=questions.length){ showResults(); return; }
  loadQuestion();
};

function showResults(){
  stopMic();
  const total=questions.length;
  const pct=Math.round((points/total)*100);
  resultsScore.textContent = `${points}/${total}ï¼ˆ${pct}%ï¼‰`;

  let msg = "ã„ã„ã­ï¼ã‚ã¨å°‘ã—ã§ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆï¼";
  let snd = RES.r1114;

  if(points<=5){ msg="ãƒ–ãƒ¼ãƒªã‚­ãƒ¥ãƒ©ãƒ è¦‹ã¦ãªã„ã§ã—ã‚‡ï¼"; snd=RES.r05; }
  else if(points<=10){ msg="YouTubeè¦‹ã™ãï¼ãƒ–ãƒ¼ãƒªã‚­ãƒ¥ãƒ©ãƒ ã‚‚ã‚„ã‚ã†ï¼"; snd=RES.r610; }
  else if(points===15){ msg="ã™ã”ã„ï¼ã‚ãªãŸã¯åœ°çƒã§ä¸€ç•ªé ­ãŒã„ã„ï¼"; snd=RES.r15; }

  resultsMsg.textContent = msg;
  resultsOverlay.style.display='flex';
  resultsOverlay.setAttribute('aria-hidden','false');

  try{ snd.currentTime=0; snd.play(); }catch(e){}
  if(points===15) confetti(140);
}

restartBtn.onclick=()=>{
  resultsOverlay.style.display='none';
  resultsOverlay.setAttribute('aria-hidden','true');
  current=0; points=0;
  loadQuestion();
};

// Help modal
if(helpBtn && helpModal){
  const closeEls=helpModal.querySelectorAll('[data-close-help]');
  const openHelp=()=>{helpModal.classList.add('show');helpModal.setAttribute('aria-hidden','false');};
  const closeHelp=()=>{helpModal.classList.remove('show');helpModal.setAttribute('aria-hidden','true');};
  helpBtn.addEventListener('click',openHelp);
  closeEls.forEach(el=>el.addEventListener('click',closeHelp));
  helpModal.addEventListener('click',e=>{if(e.target===helpModal)closeHelp();});
  document.addEventListener('keydown',e=>{if(e.key==='Escape')closeHelp();});
}

// Assign q01/q02... after shuffle
questions.forEach((q,i)=>q.index1=i+1);

window.onload=loadQuestion;
</script>
</body>
</html>
