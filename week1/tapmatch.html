<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Booha Tap Match ‚Äì January Week 1</title>
<link rel="icon" type="image/png" sizes="32x32" href="BoohaYellow.png">
<link rel="apple-touch-icon" href="BoohaYellow.png">    
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Noto+Sans+JP:wght@500;700&display=swap" rel="stylesheet">

<style>
:root{
--dark:#0b1530;
--ink:#ffffff;
--green:#22c55e;
--red:#e53935;
--outline:#ffffffcc;
--check:#22c55e;
--checkGlow:0 0 12px rgba(34,197,94,.9), 0 0 28px rgba(34,197,94,.5);
--gold:#ffd166;
--cuteBlue:#60a5fa;
--cuteBlueGlow:0 0 14px rgba(96,165,250,.9), 0 0 36px rgba(96,165,250,.55);
--cardH: 140px;
--actionsH: 72px;
}

/* base */
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{
min-height:100vh;
background:var(--dark);
color:var(--ink);
font-family:'Noto Sans JP',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
display:flex;
flex-direction:column;
align-items:center;

/* ‚úÖ Restore native scrolling (Android likes body scroll) */
overflow-y:auto;
overflow-x:hidden;

overscroll-behavior-y: contain;
padding-bottom:env(safe-area-inset-bottom);
}

/* Header + footer */
header{padding:20px 16px 10px;text-align:center}
header h1{
font-family:'Cinzel',serif;letter-spacing:.5px;
font-size:clamp(1.8rem,5.2vw,2.6rem);
opacity:.95
}
header h2{
font-family:'Cinzel',serif;letter-spacing:1px;margin-top:6px;
font-size:clamp(2.0rem,6.2vw,3rem);
text-shadow:0 0 10px rgba(255,255,255,.12)
}
.subtitle-stack{opacity:.85;font-size:.95rem;letter-spacing:.08em;display:flex;gap:.4rem;justify-content:center;flex-wrap:wrap}
.subtitle-stack .en::after{content:" / "; opacity:.8}
@media (max-width:700px){
.subtitle-stack{flex-direction:column; gap:.1rem}
.subtitle-stack .en::after{content:""}
}

footer{
margin-top:auto;padding:14px 10px;opacity:.9;font-size:1rem;
font-family:'Cinzel',serif;
}

/* üîò Quit button ‚Äì smaller Booha version */
.top-nav-btn{
position:fixed;
top:8px;
left:8px;
z-index:40;
border-radius:999px;
padding:3px 8px;
border:1px solid #ffffff66;
background:rgba(15,23,42,.95);
color:#fff;
font-size:0.55rem;
font-weight:700;
letter-spacing:.04em;
cursor:pointer;
display:flex;
align-items:center;
gap:3px;
box-shadow:0 0 8px rgba(0,0,0,.6);
backdrop-filter:blur(4px);
}
.top-nav-btn .jp{
font-size:0.48rem;
line-height:1;
font-weight:700;
opacity:.9;
transform:translateY(1px);
}

/* Pages */
.page{width:100%;max-width:980px;margin:0 auto;display:none;padding:8px 16px 24px}
.page.active{display:block}

/* Round viewport + layout */
.round-viewport{width:100%;}
.round-wrap{
display:flex;gap:26px;align-items:flex-start;justify-content:center;flex-wrap:wrap;margin-top:16px;
}
.col{flex:1 1 420px;max-width:460px;display:flex;flex-direction:column;gap:14px}

/* Allow vertical scroll gestures anywhere */
.round-viewport,
.round-wrap,
.card,
.col { touch-action: pan-y; }

/* MOBILE layout improvements */
@media (max-width:700px){
/* ‚úÖ slightly smaller tiles on mobile */
:root{ --cardH: 86px; }

/* ‚úÖ IMPORTANT: stop inner div scrolling (Android hates nested scrollbars) */
.round-viewport{
  overflow:visible;
  min-height:auto;
  padding-bottom: 0;
}

/* Keep layout as two columns */
#page-round.page.active{display:flex; flex-direction:column; padding-bottom:0;}
.round-wrap{flex-wrap:nowrap;gap:10px}

/* ‚úÖ more side grab space */
.col{flex:0 0 48%;max-width:48%}

.card{
height:var(--cardH);
padding:10px 12px;
font-size:1.1rem;
}
.card.en{font-size:1.4rem;}
.card.jp{font-size:.9rem;line-height:1.35;}

/* Sticky actions stays */
.actions{
position:sticky; bottom:0; z-index:5;
height: var(--actionsH);
display:flex; align-items:center; justify-content:center;
padding: 8px 0 calc(env(safe-area-inset-bottom));
background: linear-gradient(180deg, transparent, rgba(11,21,48,.28) 40%, rgba(11,21,48,.55));
backdrop-filter: blur(2px);
margin-top: 6px;
}
}

/* Cards */
.card{
border-radius:24px;
height:var(--cardH);
padding:18px 20px;
display:flex; align-items:center; justify-content:center; text-align:center;
font-size:clamp(1.4rem,4.6vw,2.4rem); font-weight:700; line-height:1.2;
user-select:none;
transition:transform .15s ease, box-shadow .2s ease, background .2s ease, border-color .2s ease, color .2s ease, filter .2s ease;
word-break:break-word;
cursor:pointer;
}
.card.en{
color:#000; font-weight:1000;
font-size:clamp(1.8rem,5.8vw,3rem);
letter-spacing:-.01em;
word-break: keep-all;
overflow-wrap: normal;
hyphens: none;
}
.card.jp{
background:transparent; border:3px dashed var(--outline); color:var(--ink);
white-space:pre-line;
}

/* ‚úÖ Selected glow (tap) */
.card.selected{
transform:scale(1.02);
box-shadow:
0 0 0 3px rgba(255,255,255,.55),
0 0 18px rgba(255,255,255,.55),
0 0 36px rgba(255,209,102,.55);
border-color:#fff !important;
}

/* ‚úÖ JP ‚Äúwake up‚Äù when an English is selected */
.jpAwake .card.jp:not(.combined):not(.correct):not(.wrong){
filter: brightness(1.08);
border-color:#ffffffdd;
box-shadow: 0 0 10px rgba(255,255,255,.18);
}

/* Combined before grading */
.card.combined{ border:0; display:flex; flex-direction:column; gap:8px; }
.card.matchedBlue{
background:var(--cuteBlue)!important;
color:#fff!important;
box-shadow:var(--cuteBlueGlow)!important;
}
.card.combined .enTxt{font-size:1.05em; font-weight:1000; letter-spacing:-.01em}
.card.combined .jpTxt{font-size:.7em; opacity:.98}

/* ‚úÖ Tiny ‚Äúpop‚Äù feedback when pairing */
@keyframes pairPop{
0%{transform:scale(0.98)}
60%{transform:scale(1.03)}
100%{transform:scale(1)}
}
.card.pairedPop{ animation: pairPop .18s ease-out; }

/* Grading wins */
.card.correct{background:var(--green) !important; color:#062a12 !important; border:0 !important}
.card.wrong {background:var(--red) !important; color:#fff !important; border:0 !important; animation:shake .45s}
.card.locked{pointer-events:none}
@keyframes shake{
0%,100%{transform:translateX(0)}
20%{transform:translateX(-8px)}
40%{transform:translateX(8px)}
60%{transform:translateX(-6px)}
80%{transform:translateX(6px)}
}

/* Buttons */
.actions{display:flex;gap:14px;justify-content:center;margin-top:18px;flex-wrap:wrap}
.btn{
border:0; border-radius:28px; padding:12px 34px; font-weight:800; font-size:1.1rem; cursor:pointer;
transition:transform .08s ease, box-shadow .2s ease, filter .2s ease;
touch-action: manipulation;
}
.btn:active{transform:translateY(1px)}
.btn-green{ background:var(--check); color:#062a12; box-shadow:var(--checkGlow) }
.btn-green:disabled{filter:saturate(.2) brightness(.8); box-shadow:none; cursor:not-allowed}
.btn-secondary{
background:rgba(15,23,42,.9);
color:#fff;
border:1px solid #ffffff66;
box-shadow:0 0 12px rgba(0,0,0,.6);
font-size:1rem;
}

/* Results */
#page-results .result-box{
min-height:62vh; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center;
}
.result-msg{font-family:'Noto Sans JP',sans-serif;font-size:clamp(2.4rem,6.4vw,3.2rem);margin-bottom:18px}
.result-score{font-size:clamp(1.8rem,5.4vw,2.4rem);opacity:.95}

/* Glow backgrounds */
.redGlow{background:#900; box-shadow:inset 0 0 60px 30px #ff2b2b}
.orangeGlow{background:#a34f00; box-shadow:inset 0 0 60px 30px #ff9e2b}
.blueGlow{background:#0d2b7a; box-shadow:inset 0 0 60px 30px #2b7bff}
.goldGlow{background:#725c00; box-shadow:inset 0 0 80px 40px #ffd166}

/* Perfect-run confetti rain */
.confetti{
position:fixed; width:12px; height:12px; border-radius:50%;
top:-12px; left:0;
animation:fall 1.2s linear forwards;
pointer-events:none; z-index:10;
}
@keyframes fall{
0%{transform:translateY(0) rotate(0)}
100%{transform:translateY(110vh) rotate(720deg)}
}

/* Per-card effects */
.bit{
position:fixed; width:14px; height:14px; border-radius:3px;
pointer-events:none; z-index:20; animation:pop 760ms ease-out forwards;
}
@keyframes pop{
0%{opacity:1; transform:translate(0,0) scale(1) rotate(0deg)}
100%{opacity:0; transform:translate(var(--dx),var(--dy)) scale(0.9) rotate(540deg)}
}
.poof{
position:fixed; width:40px; height:40px; border-radius:50%;
background:radial-gradient(closest-side, rgba(74,222,128,.97) 0%, rgba(34,197,94,.7) 55%, rgba(34,197,94,0) 70%);
filter:blur(2px);
pointer-events:none; z-index:19;
animation:puff 950ms ease-out forwards;
}
@keyframes puff{
0%{opacity:.98; transform:translate(-50%,-50%) scale(.7)}
100%{opacity:0; transform:translate(-50%,-50%) scale(7)}
}

/* English vertical stripes */
@keyframes stripesV{ from{background-position:0 0} to{background-position:0 var(--cardH)} }
.sv{ background-size:100% var(--cardH); animation:stripesV 3.2s linear infinite; }
.sv1{ background-image:repeating-linear-gradient(0deg, #ff7eb9 0 18px, #5ee6ff 18px 36px, #ffd166 36px 54px); }
.sv2{ background-image:repeating-linear-gradient(0deg, #a78bfa 0 18px, #60a5fa 18px 36px, #f472b6 36px 54px); }
.sv3{ background-image:repeating-linear-gradient(0deg, #34d399 0 18px, #fbbf24 18px 36px, #60a5fa 36px 54px); }
.sv4{ background-image:repeating-linear-gradient(0deg, #fca5a5 0 18px, #86efac 18px 36px, #93c5fd 36px 54px); }
.sv5{ background-image:repeating-linear-gradient(0deg, #f9a8d4 0 18px, #fef08a 18px 36px, #6ee7b7 36px 54px); }

hr.sep{border:0;height:1px;background:linear-gradient(90deg,transparent,#ffffff33,transparent);margin:12px 0 8px}

/* Help icon bottom-left */
.help-icon{
position:fixed;
left:14px;
bottom:calc(14px + env(safe-area-inset-bottom));
width:34px;
height:34px;
border-radius:999px;
border:none;
background:var(--cuteBlue);
box-shadow:var(--cuteBlueGlow);
color:#05101f;
font-weight:900;
font-size:1.2rem;
cursor:pointer;
display:flex;
align-items:center;
justify-content:center;
z-index:35;
}

/* Help overlay */
.help-overlay{
position:fixed;
inset:0;
background:radial-gradient(circle at top, rgba(96,165,250,.42), transparent 55%),
radial-gradient(circle at bottom, rgba(34,197,94,.35), transparent 55%),
rgba(2,6,23,.88);
display:none;
align-items:center;
justify-content:center;
z-index:50;
}
.help-overlay.show{display:flex;}
.help-dialog{
max-width:520px;
width:90%;
padding:20px 20px 18px;
border-radius:24px;
background:rgba(15,23,42,.96);
border:1px solid #ffffff55;
box-shadow:0 0 30px rgba(0,0,0,.8);
position:relative;
max-height:80vh;
overflow-y:auto;
-webkit-overflow-scrolling:touch;
}
.help-title{
font-family:'Cinzel',serif;
font-size:1.35rem;
margin-bottom:8px;
text-align:center;
}
.help-sub{
font-size:.9rem;
opacity:.8;
text-align:center;
margin-bottom:10px;
}
.help-content{
font-size:.92rem;
line-height:1.6;
}
.help-content ul{padding-left:1.1em;margin:4px 0 10px;}
.help-content li{margin-bottom:4px;}
.help-close{
position:absolute;
top:8px;
right:10px;
border:none;
border-radius:999px;
width:26px;
height:26px;
background:rgba(30,64,175,.9);
color:#fff;
font-weight:900;
cursor:pointer;
font-size:1rem;
}

/* Round flash */
.round-flash{
position:fixed; inset:0; z-index:60;
display:none; align-items:center; justify-content:center;
background:radial-gradient(circle at center, rgba(255,209,102,.22), rgba(2,6,23,.78));
backdrop-filter: blur(1px);
}
.round-flash.show{display:flex;}
.round-flash .box{
padding:18px 22px;
border-radius:22px;
border:1px solid #ffffff55;
background:rgba(15,23,42,.95);
box-shadow:0 0 30px rgba(0,0,0,.7);
text-align:center;
}
.round-flash .t1{font-family:'Cinzel',serif;font-size:1.4rem;letter-spacing:.06em}
.round-flash .t2{margin-top:6px;opacity:.9}
</style>
</head>

<body>

<button id="quitBtn" class="top-nav-btn">
<span>Quit</span><span class="jp">Ôºè „ÇÑ„ÇÅ„Çã</span>
</button>

<header>
<h1>THE BOO-RICULUM</h1>
<h2>TAP MATCH</h2>
<div class="subtitle-stack">
<div class="en">January Week 1 - Vocabulary</div>
<div class="jp">ÔºëÊúàÁ¨¨ÔºëÈÄ± - Ë™ûÂΩô</div>
</div>
<hr class="sep">
</header>

<section id="page-round" class="page active">
<div class="round-viewport">
<div class="round-wrap" id="tapArea">
<div id="col-en" class="col"></div>
<div id="col-jp" class="col"></div>
</div>
</div>
<div class="actions">
<button id="checkBtn" class="btn btn-green" disabled>CHECK</button>
</div>
</section>

<section id="page-results" class="page">
<div class="result-box">
<div id="resultMsg" class="result-msg">ÁµêÊûú</div>
<div id="resultScore" class="result-score">0/15 (0%)</div>
</div>
<div class="actions">
<button id="playAgain" class="btn btn-green">„ÇÇ„ÅÜ‰∏ÄÂ∫¶ Ôºè Play Again</button>
<button id="backToMenu" class="btn btn-secondary">„É°„Ç§„É≥„É°„Éã„É•„Éº„Å∏ Ôºè Main Menu</button>
</div>
</section>

<footer>Bryan's English School</footer>

<button id="helpBtn" class="help-icon">?</button>

<div id="helpOverlay" class="help-overlay">
<div class="help-dialog">
<button id="helpClose" class="help-close">√ó</button>
<div class="help-title">ÈÅä„Å≥Êñπ Ôºè How to Play</div>
<div class="help-sub">Booha Tap Match Game</div>
<div class="help-content">
<p><strong>Êó•Êú¨Ë™û</strong></p>
<ul>
<li>Â∑¶„ÅÆ<strong>Ëã±Ë™û„Ç´„Éº„Éâ</strong>„Çí„Çø„ÉÉ„Éó„Åó„Å¶ÈÅ∏„Å≥„Åæ„ÅôÔºàÂÖâ„Çä„Åæ„ÅôÔºâ„ÄÇ</li>
<li>Âè≥„ÅÆ<strong>Êó•Êú¨Ë™û„Ç´„Éº„Éâ</strong>„Çí„Çø„ÉÉ„Éó„Åó„Å¶„Éö„Ç¢„Å´„Åó„Åæ„Åô„ÄÇ</li>
<li>„Éö„Ç¢„Å´„Åô„Çã„Å®Èùí„ÅÑ„Ç´„Éº„Éâ„Å´„Å™„Çä„ÄÅËã±Ë™ûÔºãÊó•Êú¨Ë™ûÔºà„Åµ„Çä„Åå„Å™Ôºâ„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô„ÄÇ</li>
<li>„Åæ„Å°„Åå„Åà„Åü„Çâ„ÄÅÈùí„ÅÑ„Ç´„Éº„Éâ„Çí„Çø„ÉÉ„Éó„Åô„Çã„Å®<strong>Âèñ„ÇäÊ∂à„Åó</strong>„Åß„Åç„Åæ„Åô„ÄÇ</li>
<li>5„Å§„Åô„Åπ„Å¶„Éö„Ç¢„Å´„Åß„Åç„Åü„Çâ„ÄÅ<strong>CHECK</strong>„ÇíÊäº„Åó„Åæ„Åô„ÄÇ</li>
<li><strong>3„É©„Ç¶„É≥„ÉâÔºàÂêàË®à15ÂïèÔºâ</strong>„ÅÇ„Çä„Åæ„Åô„ÄÇ„Éë„Éº„Éï„Çß„ÇØ„Éà„ÇíÁõÆÊåá„Åó„Å¶„Å≠ÔºÅ</li>
</ul>

<hr class="sep" style="margin:8px 0;">

<p><strong>English</strong></p>
<ul>
<li>Tap an <strong>English card</strong> to select it (it will glow).</li>
<li>Tap the matching <strong>Japanese card</strong> to make a pair.</li>
<li>Paired cards turn <strong>blue</strong> and show English + Japanese (hiragana).</li>
<li>If you make a mistake, tap the blue card to <strong>undo</strong>.</li>
<li>When all 5 pairs are made, tap <strong>CHECK</strong>.</li>
<li>There are <strong>3 rounds</strong> (15 total). Try for a perfect score!</li>
</ul>
</div>
</div>
</div>

<div id="roundFlash" class="round-flash">
<div class="box">
<div class="t1" id="roundFlashT1">ROUND 1</div>
<div class="t2" id="roundFlashT2">„É©„Ç¶„É≥„ÉâÔºë</div>
</div>
</div>

<!-- SFX + results (paths assigned by JS so it works from root OR inside /week1/) -->
<audio id="s_ding"  preload="auto" playsinline></audio>
<audio id="s_fart"  preload="auto" playsinline></audio>
<audio id="s_r05"   preload="auto" playsinline></audio>
<audio id="s_r610"  preload="auto" playsinline></audio>
<audio id="s_r1114" preload="auto" playsinline></audio>
<audio id="s_r15"   preload="auto" playsinline></audio>



<!-- ‚úÖ One reusable vocab player -->
<audio id="vocabPlayer" preload="auto" playsinline></audio>

<script>
/* DATA */
const MASTER = [
{id:1, en:"goal",jp:"ÁõÆÊ®ô",hira:"„ÇÇ„Åè„Å≤„Çá„ÅÜ"},
{id:2, en:"plan",jp:"Ë®àÁîª",hira:"„Åë„ÅÑ„Åã„Åè"},
{id:3, en:"future",jp:"Êú™Êù•",hira:"„Åø„Çâ„ÅÑ"},
{id:4, en:"dream",jp:"Â§¢",hira:"„ÇÜ„ÇÅ"},
{id:5, en:"challenge",jp:"ÊåëÊà¶",hira:"„Å°„Çá„ÅÜ„Åõ„Çì"},
{id:6, en:"try",jp:"ÊåëÊà¶„Åô„Çã",hira:"„Å°„Çá„ÅÜ„Åõ„Çì „Åô„Çã"},
{id:7, en:"change",jp:"Â§â„Åà„Çã",hira:"„Åã„Åà„Çã"},
{id:8, en:"habit",jp:"ÁøíÊÖ£",hira:"„Åó„ÇÖ„ÅÜ„Åã„Çì"},
{id:9, en:"exercise",jp:"ÈÅãÂãï",hira:"„ÅÜ„Çì„Å©„ÅÜ"},
{id:10,en:"study",jp:"ÂãâÂº∑",hira:"„Åπ„Çì„Åç„Çá„ÅÜ"},
{id:11,en:"learn",jp:"Â≠¶„Å∂",hira:"„Åæ„Å™„Å∂"},
{id:12,en:"practice",jp:"Á∑¥Áøí",hira:"„Çå„Çì„Åó„ÇÖ„ÅÜ"},
{id:13,en:"success",jp:"ÊàêÂäü",hira:"„Åõ„ÅÑ„Åì„ÅÜ"},
{id:14,en:"focus",jp:"ÈõÜ‰∏≠",hira:"„Åó„ÇÖ„ÅÜ„Å°„ÇÖ„ÅÜ"},
{id:15,en:"motivation",jp:"„ÇÑ„ÇãÊ∞ó",hira:"„ÇÑ„Çã„Åç"}
];

/* State */
let rounds=[], roundIndex=0, totalScore=0, connections={}, jpOrder=[];
let audioUnlocked=false;
let selectedEn = null;
let selectedEnId = null;
let selectedEnEl = null;
let isGrading = false;

/* Helpers */
const $ = s => document.querySelector(s);

/* ‚úÖ Works whether this HTML is at repo root OR inside /week1/ */
const WEEK_PREFIX = location.pathname.includes('/week1/') ? '' : 'week1/';

function setAudioSrc(id, relPath){
  const el = document.getElementById(id);
  if(!el) return;
  el.src = WEEK_PREFIX + relPath;
}

function initAudioPaths(){
  setAudioSrc('s_ding',  'assets/audio/ding.mp3');
  setAudioSrc('s_fart',  'assets/audio/fart.mp3');

  setAudioSrc('s_r05',   'assets/audio/result_0-5.mp3');
  setAudioSrc('s_r610',  'assets/audio/result_6-10.mp3');
  setAudioSrc('s_r1114', 'assets/audio/result_11-14.mp3');
  setAudioSrc('s_r15',   'assets/audio/result_15.mp3');
}

/* Call immediately (safe before gameplay) */
initAudioPaths();

function playSfx(id){
  const src = document.getElementById(id);
  if(!src) return;

  const a = src.cloneNode(true);
  a.setAttribute('playsinline','');
  a.currentTime = 0;

  document.body.appendChild(a);
  a.play().catch(()=>{}).finally(()=>setTimeout(()=>a.remove(), 2000));
}

/* ‚úÖ END scorecard audio (longer) */
function playEndCard(el){
  if(!el) return;

  const a = el.cloneNode(true);
  a.setAttribute('playsinline','');
  a.currentTime = 0;

  document.body.appendChild(a);
  a.play().catch(()=>{}).finally(()=>{
    setTimeout(()=>a.remove(), 12000);
  });
}

function centerOf(el){
  const r = el.getBoundingClientRect();
  return { x: r.left + r.width/2, y: r.top + r.height/2 };
}

function shuffle(a){
  return a
    .map(v => [Math.random(), v])
    .sort((x,y) => x[0] - y[0])
    .map(x => x[1]);
}

/* Effects */
function burstConfettiAt(el,count=44){
const {x,y}=centerOf(el);
for(let i=0;i<count;i++){
const b=document.createElement('div'); b.className='bit';
b.style.left=x+'px'; b.style.top=y+'px';
const ang=Math.random()*2*Math.PI, dist=80+Math.random()*130;
b.style.setProperty('--dx', Math.cos(ang)*dist+'px');
b.style.setProperty('--dy', Math.sin(ang)*dist-10+'px');
b.style.background=`hsl(${Math.random()*360},100%,60%)`;
document.body.appendChild(b); setTimeout(()=>b.remove(),820);
}
}
function fartPoofAt(el){
const {x,y}=centerOf(el);
const p=document.createElement('div'); p.className='poof';
p.style.left=x+'px'; p.style.top=y+'px';
document.body.appendChild(p); setTimeout(()=>p.remove(),980);
}

/* Local vocab audio */
function pad2(n){ return String(n).padStart(2,'0'); }
function safeWord(s){
return (s||"").toLowerCase().trim().replace(/\s+/g,'_').replace(/[^a-z0-9_'-]/g,'');
}
function vocabSrc(id, en){
  return `${WEEK_PREFIX}audio/vocab/v${pad2(id)}_${safeWord(en)}.mp3`;
}

function playVocabById(id, en){
if(!id || !en) return;
const p = $("#vocabPlayer");
if(!p) return;
p.pause();
p.currentTime = 0;
p.src = vocabSrc(id, en);
p.play().catch(()=>{});
}

/* ‚úÖ FIX: remove ‚Äúautoplay blip‚Äù
   We DO NOT play/pause on a global touch anymore.
   We unlock only on the first real game action (tap EN/JP/CHECK). */
function unlockAudioOnce(){
if(audioUnlocked) return;
audioUnlocked = true;
/* no play() here ‚Äî just marking unlocked */
}

/* Attach unlock to real actions */
function armUnlockOn(el, evt="pointerdown"){
if(!el) return;
el.addEventListener(evt, unlockAudioOnce, {once:true, passive:true});
}

/* Selection UI */
function setJpAwake(on){
document.body.classList.toggle('jpAwake', !!on);
}
function clearEnSelection(){
if(selectedEnEl) selectedEnEl.classList.remove('selected');
selectedEn = null;
selectedEnId = null;
selectedEnEl = null;
setJpAwake(false);
}

/* Clear JP slot */
function clearJPCard(jpCard){
const enText = jpCard.dataset.connected;
const enId = Number(jpCard.dataset.connectedId || 0);
if(!enText) return;

playVocabById(enId, enText);

const enCard = document.querySelector(`.en[data-en="${enText}"][data-id="${enId}"]`);
if(enCard) enCard.style.visibility = 'visible';

jpCard.classList.remove('combined','matchedBlue','pairedPop','correct','wrong','locked');
jpCard.classList.add('jp');
jpCard.innerHTML = `${jpCard.dataset.jp}\n(${jpCard.dataset.hira})`;

jpCard.dataset.connected = "";
jpCard.dataset.connectedId = "";
delete connections[jpCard.dataset.jp];

$("#checkBtn").disabled = Object.keys(connections).length !== 5;
clearEnSelection();
}

/* Combine */
function combineIntoJP(jpCard, enText, enId){
if(!jpCard || !jpCard.dataset) return;

if(jpCard.dataset.connected){
const oldText = jpCard.dataset.connected;
const oldId = Number(jpCard.dataset.connectedId || 0);
const old = document.querySelector(`.en[data-en="${oldText}"][data-id="${oldId}"]`);
if(old) old.style.visibility='visible';
}

const enCard=document.querySelector(`.en[data-en="${enText}"][data-id="${enId}"]`);
if(enCard) enCard.style.visibility='hidden';

const jp = jpCard.dataset.jp, hira = jpCard.dataset.hira;
jpCard.classList.add('combined','matchedBlue','pairedPop');
jpCard.classList.remove('jp','selected');
jpCard.innerHTML = `<div class="enTxt">${enText}</div><div class="jpTxt">${jp}Ôºà${hira}Ôºâ</div>`;
jpCard.dataset.connected = enText;
jpCard.dataset.connectedId = String(enId);
connections[jp] = `${enId}|${enText}`;

setTimeout(()=>jpCard.classList.remove('pairedPop'), 220);

$("#checkBtn").disabled = Object.keys(connections).length !== 5;
clearEnSelection();
}

/* Round flash */
function showRoundFlash(n){
const o = $("#roundFlash");
const t1 = $("#roundFlashT1");
const t2 = $("#roundFlashT2");
if(!o||!t1||!t2) return;
t1.textContent = `ROUND ${n}`;
t2.textContent = `„É©„Ç¶„É≥„Éâ${n}`;
o.classList.add('show');
setTimeout(()=>o.classList.remove('show'), 1000);
}

/* Init */
function initGame(){
totalScore=0; roundIndex=0; document.body.className='';
$("#page-results").classList.remove('active'); $("#page-round").classList.add('active');
clearEnSelection();
isGrading = false;

const shuffled=shuffle([...MASTER]);
rounds=[shuffled.slice(0,5),shuffled.slice(5,10),shuffled.slice(10,15)];
showRoundFlash(1);
loadRound();
}

/* Build round */
function loadRound(){
connections={};
clearEnSelection();
isGrading = false;

const set=rounds[roundIndex], colEn=$("#col-en"), colJp=$("#col-jp");
colEn.innerHTML=""; colJp.innerHTML="";

const stripeClasses=shuffle(['sv1','sv2','sv3','sv4','sv5']);

shuffle([...set]).forEach((item,idx)=>{
const c=document.createElement('div');
c.className=`card en sv ${stripeClasses[idx % stripeClasses.length]}`;
c.textContent=item.en.toLowerCase();
c.dataset.en=item.en.toLowerCase();
c.dataset.id=String(item.id);

/* Unlock on first real tap */
armUnlockOn(c);

/* Tap EN: select + replay */
c.addEventListener('click', ()=>{
if(isGrading) return;
if(c.style.visibility === 'hidden') return;

playVocabById(item.id, item.en);

if(selectedEnEl === c){
return;
}
clearEnSelection();
selectedEn = item.en.toLowerCase();
selectedEnId = item.id;
selectedEnEl = c;
c.classList.add('selected');
setJpAwake(true);
});

colEn.appendChild(c);
});

shuffle([...set]).forEach(item=>{
const c=document.createElement('div');
c.className='card jp';
c.dataset.jp=item.jp; c.dataset.hira=item.hira; c.dataset.connected=""; c.dataset.connectedId="";
c.textContent=`${item.jp}\n(${item.hira})`;

/* Unlock on first real tap */
armUnlockOn(c);

c.addEventListener('click', ()=>{
if(isGrading) return;
if(c.classList.contains('correct') || c.classList.contains('wrong')) return;

if(c.dataset.connected){
clearJPCard(c);
return;
}
if(!selectedEn) return;

combineIntoJP(c, selectedEn, selectedEnId);
/* feel-good replay */
playVocabById(selectedEnId, selectedEn);
});

colJp.appendChild(c);
});

jpOrder=[...colJp.querySelectorAll('[data-jp]')];
$("#checkBtn").disabled=true;

/* Unlock on CHECK as well */
armUnlockOn($("#checkBtn"));
}

/* Check flow */
$("#checkBtn").addEventListener('click',()=>{
unlockAudioOnce(); /* in case first action is CHECK */
if(isGrading) return;
isGrading = true;
$("#checkBtn").disabled=true;
clearEnSelection();

let i=0;
const step=setInterval(()=>{
if(i>=jpOrder.length){
clearInterval(step);
setTimeout(()=>{
roundIndex++;
if(roundIndex<3){
showRoundFlash(roundIndex+1);
loadRound();
}else{
showResults();
}
},900);
return;
}
const card=jpOrder[i], jp=card.dataset.jp;
const chosen=card.dataset.connected||"";
const correct = rounds.flat().find(v=>v.jp===jp)?.en.toLowerCase();

card.classList.remove('matchedBlue','pairedPop');

if(chosen && chosen===correct){
card.classList.remove('wrong');
card.classList.add('correct','locked');
playSfx('s_ding');
burstConfettiAt(card,44);
totalScore++;
}else{
card.classList.remove('correct');
card.classList.add('wrong');
playSfx('s_fart');
fartPoofAt(card);
}
i++;
},850);
});

/* Results */
function showResults(){
  $("#page-round").classList.remove('active');
  $("#page-results").classList.add('active');

  const pct = Math.round((totalScore / 15) * 100);
  const msgEl = $("#resultMsg");
  const scoreEl = $("#resultScore");

  let bg = 'blueGlow';
  let msg = '„ÅÑ„ÅÑ„Å≠ÔºÅ„ÅÇ„Å®Â∞ë„Åó„Åß„Éë„Éº„Éï„Çß„ÇØ„ÉàÔºÅ';
  let snd = $("#s_r1114");

  if (totalScore <= 5) {
    bg = 'redGlow';
    msg = '„Éñ„Éº„É™„Ç≠„É•„É©„É†Ë¶ã„Å¶„Å™„ÅÑ„Åß„Åó„ÇáÔºÅ';
    snd = $("#s_r05");
  } else if (totalScore <= 10) {
    bg = 'orangeGlow';
    msg = 'YouTubeË¶ã„Åô„ÅéÔºÅ„Éñ„Éº„É™„Ç≠„É•„É©„É†„ÇÇ„ÇÑ„Çç„ÅÜÔºÅ';
    snd = $("#s_r610");
  } else if (totalScore === 15) {
    bg = 'goldGlow';
    msg = '„Åô„Åî„ÅÑÔºÅ„ÅÇ„Å™„Åü„ÅØÂú∞ÁêÉ„Åß‰∏ÄÁï™È†≠„Åå„ÅÑ„ÅÑÔºÅ';
    snd = $("#s_r15");
  }

  document.body.className = bg;
  msgEl.textContent = msg;
  scoreEl.textContent = `${totalScore}/15Ôºà${pct}%Ôºâ`;

  playEndCard(snd);

  if (totalScore === 15) {
    for (let i = 0; i < 160; i++) {
      setTimeout(() => {
        const c = document.createElement('div');
        c.className = 'confetti';
        c.style.left = (Math.random() * 100) + 'vw';
        c.style.background = `hsl(${Math.random() * 360},100%,60%)`;
        c.style.animationDuration = (0.9 + Math.random() * 0.9) + 's';
        document.body.appendChild(c);
        setTimeout(() => c.remove(), 1900);
      }, i * 10);
    }
  }
}


/* Buttons */
$("#playAgain").addEventListener('click', initGame);
$("#backToMenu").addEventListener('click', () => { window.location.href = "index.html"; });
$("#quitBtn").addEventListener('click', () => { window.location.href = "index.html"; });

/* Help overlay logic */
const helpOverlay = $("#helpOverlay");
$("#helpBtn").addEventListener('click', () => { helpOverlay.classList.add('show'); });
$("#helpClose").addEventListener('click', () => { helpOverlay.classList.remove('show'); });
helpOverlay.addEventListener('click', (e) => { if(e.target === helpOverlay) helpOverlay.classList.remove('show'); });

initGame();
</script>
</body>
</html>
